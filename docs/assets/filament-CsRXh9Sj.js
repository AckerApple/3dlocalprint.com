import"./version-DY3vLLu-.js";import{t as k,d as u,s as F,b as v,l as N,a as $,o as _,i as T,c as aa,e as Q,n as na,h as oa,m as ta,f as sa,p as ra,g as ea,j as la,k as ia,q as ca,r as O,u as ua,v as A,w as da,x as ma,y as pa,z as fa,A as ha,B as ya,C as _a,D as ba}from"./toast-Dm6QH7Hm.js";import{o as L}from"./barcode-utils-Bh5zqa5o.js";import{d as D}from"./filament-match-utils-C2oTVrRR.js";import{A as Fa}from"./AdminNav.tag-BK0PKYst.js";import{m as ga}from"./filter-utils-CsgsWdIu.js";import"./adminNavItems-u5BZOrdS.js";const C=["Fireguys","Apples"],q=(a,n)=>({onChange:t=>{var o;a[n]=((o=t==null?void 0:t.target)==null?void 0:o.value)??""},onKeyup:t=>{var o;a[n]=((o=t==null?void 0:t.target)==null?void 0:o.value)??""}}),W=k((a,n,t,o,e,d,l)=>{W.updates(s=>{[a,n,t,o,e,d,l]=s,o=L(o)}),o=L(o);let i=!1;const p=()=>{i=!0},m=()=>{i=!0},c=()=>{if(!e||!i)return;const s=e(),f=()=>{i=!1,o(n,(a==null?void 0:a.location)??"")};if(s&&typeof s.then=="function"){s.then(f);return}f()},g=()=>{d&&d(n)},S=s=>{var M;const f=((M=s==null?void 0:s.target)==null?void 0:M.value)||"";a.location=f,typeof l=="function"&&l(n,f),p()};return u.class`swatch-card`(u.class`edit-card-header`(F.class`edit-card-title`(s=>D(t==null?void 0:t.find(f=>f.filament_type_id===a.filament_type_id))||"Filament inventory"),u.class`edit-card-actions`(e?v.type`button`.class`add-button`.disabled(s=>!i).onClick(c)("ðŸ’¾ Save"):null,d?v.type`button`.class`ghost-button`.onClick(g)("ðŸ§¬ Duplicate"):null,v.type`button`.class`edit-card-toggle`.onClick(()=>o(n,(a==null?void 0:a.location)??"")).attr("aria-label","Stop editing inventory")("Done"))),u.class`fields`.onInput(m).onChange(m).onKeydown(s=>{s.key==="Enter"&&(s.preventDefault(),c())})(N("Filament type",$.onChange(s=>{var f;a.filament_type_id=((f=s==null?void 0:s.target)==null?void 0:f.value)||"",p()})(_.value``.selected(s=>!a.filament_type_id)("Select filament type"),...(t||[]).map(s=>_.value(s.filament_type_id).selected(f=>a.filament_type_id===s.filament_type_id)(D(s)||s.label||"Unnamed")))),N("ðŸ“ Location",$.onChange(S)(_.value``.selected(s=>!a.location)("Select location"),...C.map(s=>_.value(s).selected(f=>a.location===s)(s).key(s)))),N("Spool Inventory",T.type`number`.value(s=>a.spool_inventory??"").onChange(q(a,"spool_inventory").onChange).onKeyup(q(a,"spool_inventory").onKeyup)())))}),va=a=>/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(a),Aa=a=>{if(!a)return"";try{return new URL(a).hostname.replace(/^www\./,"")}catch{return a.replace(/^https?:\/\//,"").split("/")[0]}},X=k((a,n,t,o,e)=>{X.updates(l=>{[a,n,t,o,e]=l}),o=L(o);const d=(l,i)=>{const p=Number(a.spool_inventory),m=Math.max(0,(Number.isFinite(p)?p:0)+i);if(a.spool_inventory=m,l!=null&&l.currentTarget){const c=l.currentTarget;c.classList.add("is-clicked"),window.setTimeout(()=>c.classList.remove("is-clicked"),220)}if(e){const c=e();c&&typeof c.then=="function"&&c.catch(()=>{})}};return u.class`summary-row`(u(l=>(n==null?void 0:n.number)||"-"),u.class`summary-swatch`(u.class`summary-chip`.style(l=>`background:${va(n==null?void 0:n.hex)?n.hex:""};`)(),F.class`summary-swatch-name`(l=>(n==null?void 0:n.color_name)||"Unnamed")),u.class`summary-details`(u.class`summary-title-row`(aa(l=>(n==null?void 0:n.label)||"Untitled filament"),v.type`button`.class`summary-edit-button`.onClick(()=>{o(t,(a==null?void 0:a.location)??"")})({"aria-label":"Edit inventory entry"},"âœï¸")),l=>{const i=[],p=D(n);p&&i.push(F.class`summary-meta-item`(p));const m=n!=null&&n.material_type?`Material: ${n.material_type}`:"Material: N/A";if(i.push(F.class`summary-meta-item`(m)),i.push(F.class`summary-meta-item summary-spool-meta`(F.class`summary-spool-label`("Spools:"),F.class`summary-spool-count`(c=>{const g=Number(a.spool_inventory);return Number.isFinite(g)?g:0}),u.class`summary-spool-controls`(v.type`button`.class`spool-adjust-button`.attr("aria-label","Decrease spool count").onClick(c=>d(c,-1))("âˆ’"),v.type`button`.class`spool-adjust-button`.attr("aria-label","Increase spool count").onClick(c=>d(c,1))("+")))),n!=null&&n.url){const c=Aa(n.url);i.push(F.class`summary-meta-item`(Q.href(n.url).attr("target","_blank").attr("rel","noopener noreferrer")(c||n.url)))}return i.length?u.class`summary-meta`(...i):""}))});let y=null;const Ca=(a,n)=>{if(y&&y.index===a&&(n===void 0||y.location===n)){y=null;return}y={index:a,location:n??""}},E=(a,n="")=>{if(a==null){y=null;return}y={index:a,location:n}},ka=(a,n="")=>{!y||y.index!==a||(y={...y,location:n})},Y=k((a,n,t,o,e,d,l,i)=>{Y.updates(m=>{[a,n,t,o,e,d,l,i]=m,e=L(e)}),e=L(e);const p=()=>(o==null?void 0:o.index)===t&&((o==null?void 0:o.location)??"")===((a==null?void 0:a.location)??"");return na(m=>p()?W(a,t,d,e,l,i,ka):X(a,n,t,e,l))}),Z=k((a,n,t)=>{Z.updates(r=>{[a,n,t]=r});let o=[],e=!1,d=!1;const l=()=>{var r;o.unshift(Ua(C[0]||"",a)),E(0,((r=o[0])==null?void 0:r.location)||"")},i=()=>$a(o),p=r=>{const h=o[r];if(!h)return;const I={...h,location:h.location||C[0]||""};o.splice(r+1,0,I),E(r+1,I.location||"")};let m="",c="";const g="__unassigned__",S="Unassigned",s=()=>Da(o,a,{filamentTypeFilter:c,locationFilter:m,unassignedLocation:g}),f=()=>Ma(s(),[...C,S]);return(()=>{if(!O){console.debug("FilamentInventoryApp load skipped: no loader provided");return}e||d||(d=!0,console.debug("FilamentInventoryApp loading inventory..."),k.promise=O().then(r=>{console.debug("FilamentInventoryApp load complete",{count:(r==null?void 0:r.length)||0}),o=P(r||[]),e=!0}).catch(r=>{console.error("FilamentInventoryApp load failed",r),o=P([]),e=!0}).finally(()=>{d=!1}))})(),[oa(Fa(n,t),sa("Filament Inventory"),ra("Edit filament inventory in place. Changes are saved directly to Firestore.")),ta(ea.class`panel`(u.class`meta`(u.class`controls`(u.class`controls-group`(v({id:"addFilamentButton",class:"add-button",type:"button",onClick:l},"âž• Add filament")),u.class`controls-group`($.value(r=>c??"").onChange(r=>{var h;c=((h=r==null?void 0:r.target)==null?void 0:h.value)||""})(_.value``("Filter by filament type"),...(a||[]).map(r=>_.value(r.filament_type_id)(D(r)||r.label||"Untitled"))),$.value(r=>m??"").onChange(r=>{var h;m=((h=r==null?void 0:r.target)==null?void 0:h.value)||""})(_.value``("ðŸ“ Filter by location"),...C.map(r=>_.value(r)(r)),_.value(g)("Unassigned")),u.id`count`(r=>`${s().length} items`)))),u.id`summaryList`.class`summary-list`(r=>f().map(([h,I])=>u.class`location-group`(u.class`location-title-row`(la.class`location-title`(`ðŸ“ ${h} (${I.length})`),h===S?null:Q.class`ghost-button location-fast-edit`.href`./${ia(h)}/fast-edit.html`("âš¡ Fast edit")),za=>I.map(({item:V,index:H,type:R})=>Y(V,R,H,y,Ca,a,i,p).key(V.filament_type_id||`item-${H}`))).key(h)))))]}),Ia=a=>C.includes(a)?a:"",La=a=>(Array.isArray(a)?a:[]).map(n=>({...n,location:Ia(n.location)})),Sa=a=>a.map(n=>{const t={};return n.filament_type_id&&(t.filament_type_id=n.filament_type_id),n.location&&(t.location=n.location),n.spool_inventory!==void 0&&n.spool_inventory!==""&&(t.spool_inventory=Number(n.spool_inventory)||0),t}),Ua=(a="",n=[])=>{var t;return{filament_type_id:((t=n==null?void 0:n[0])==null?void 0:t.filament_type_id)||"",spool_inventory:1,location:a}},P=a=>{const n=La(a);return console.debug("Filament inventory loaded",{count:n.length}),n},$a=a=>ca(Sa(a)).catch(n=>{console.error("Failed to save filament inventory",n),alert("Save failed. Check the console for details.")}),Da=(a,n,t)=>a.reduce((o,e,d)=>{const l=!t.filamentTypeFilter||e.filament_type_id===t.filamentTypeFilter,i=ga(e.location,t.locationFilter,t.unassignedLocation);if(l&&i){const p=n==null?void 0:n.find(m=>m.filament_type_id===e.filament_type_id);o.push({item:e,index:d,type:p})}return o},[]),Ma=(a,n)=>{const t=new Map;return n.forEach(o=>{t.set(o,[])}),a.forEach(o=>{const e=o.item.location||n[n.length-1];t.has(e)||t.set(e,[]),t.get(e).push(o)}),Array.from(t.entries()).filter(([,o])=>o.length)},z={current:document.getElementById("filamentApp")};let j=[],b=null,w=!1,B=!1,K=null;const x=()=>ua().catch(a=>{console.error("Firebase sign-out failed",a),A.error("Sign out failed. Try again.")}),Na=k(()=>Z(j,x,K)),G=(a="")=>{if(!z.current||B)return;const n=ya(z);n&&(n.replaceChildren(),_a(Na,n),B=!0)},U=(a,n,t="")=>{da({rootRef:z,status:a,userEmail:n,adminEmail:"",onSignIn:()=>ba().catch(o=>{console.error("Firebase sign-in failed",o),A.error("Sign in failed. Try again.")}),onSignOut:x,setAppMounted:o=>{B=o}})};U("loading","","initial");const J=async(a,n="")=>{if(w=!1,!a){K=null,b&&(b(),b=null),U("login","","auth:logged-out");return}K={email:a.email||"",photoURL:a.photoURL||""};let t=!1;try{t=await fa(a.email||"")}catch(o){console.error("Failed to load admin list",o),A.error("Unable to verify access. Check Firestore rules."),U("denied",a.email||"","auth:permissions");return}if(!t){b&&(b(),b=null),A.error(`Signed in as ${a.email||"unknown"} but not authorized.`),U("denied",a.email||"","auth:denied");return}w=!0,b||(b=ha(o=>{if(Array.isArray(o)?j=o:j=[],w){G("types:update");return}})),G("auth:authorized")},wa=async()=>{ma().then(({redirectError:a,redirectResult:n,persistence:t})=>{a&&A.error("Sign-in failed after redirect. Try again."),t.error&&A.error("Safari blocked login storage. Check cookie settings."),n!=null&&n.user&&J(n.user,"redirectResult")}).catch(a=>{console.error("Failed to prepare auth",a),A.error("Sign-in setup failed. Try again.")}),pa(a=>{J(a,"onAuthChanged")})};wa();
