import"./version-eUJUTvkd.js";import{i as qe,r as Le,a as Oe,b as De,g as Te,f as Me,s as te,p as Re,c as H,d as ae,h as de,t as T,e as he,o as ue,j as f,k as O,l as pe,m as Ae,n as ge,q as S,u as L,v as M,w as P,x as $,y as K,z as Fe,A as Pe,B as Ie,C as xe,S as Be,D as He,E as Ve,F as We,G as Ue,H as re,I as me,J as Qe,K as A,L as je,M as Ne,N as Ke,O as ze,P as Ge,Q as Je,R as Xe,T as Ye}from"./toast-DbHE0DvQ.js";function Ze(a){const e=a.context;return qe(a.templater)?Le(a):Oe(a,a,e)}function D(a){if(!a)return De;const e=Te();if(!e)throw new Error("output must be used in render sync with a parent context");const t=Me(e);if(!t)throw new Error("output must be used in render sync fashion");if(a.wrapped===!0)return a;const r=(...n)=>{const s=t.ownerSupport;return et(n,a,s.context)};return r.wrapped=!0,r}function et(a,e,t){const r=t.state,n=r.newer.states,s=r.older?r.older.states:n,i=r.newest;te(n,s);const c=e(...a);return te(s,n),Re.push([()=>{const d=i.context.global;if(d===void 0||d.deleted===!0){++H.locks,i.context.tagJsVar.processUpdate(i.context.value,i.context,i,[]),--H.locks,ae();return}++H.locks,Ze(i),--H.locks,ae()},[]]),c}const tt=/\d+/g,fe=a=>{if(!a)return"";const e=a.split("#").filter(Boolean),t=a.match(tt)||[],r=[...e,...t].filter(n=>n);return r.length?r.reduce((n,s)=>s.length>n.length?s:n,""):""},at=(a,e)=>{if(!e)return[];const t=e.toLowerCase();return a.filter(r=>[r.qr_search_data,r.swatch_code,r.number,r.label,r.color_name].filter(s=>s!=null).map(s=>s.toString().toLowerCase()).some(s=>s.includes(t)))},rt=/\d+/g,ye=a=>{if(!a)return"";const e=a.split("#").filter(Boolean),t=a.match(rt)||[],r=[...e,...t].filter(n=>n);return r.length?r.reduce((n,s)=>s.length>n.length?s:n,""):""},nt=(a,e)=>{if(!e)return[];const t=e.toLowerCase();return a.filter(r=>[r.barcode_search_data,r.swatch_code,r.number,r.label,r.color_name].filter(s=>s!=null).map(s=>s.toString().toLowerCase()).some(s=>s.includes(t)))},st="modulepreload",ot=function(a,e){return new URL(a,e).href},ne={},it=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let i=function(g){return Promise.all(g.map(_=>Promise.resolve(_).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const c=document.getElementsByTagName("link"),d=document.querySelector("meta[property=csp-nonce]"),l=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));n=i(t.map(g=>{if(g=ot(g,r),g in ne)return;ne[g]=!0;const _=g.endsWith(".css"),u=_?'[rel="stylesheet"]':"";if(!!r)for(let o=c.length-1;o>=0;o--){const y=c[o];if(y.href===g&&(!_||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${g}"]${u}`))return;const v=document.createElement("link");if(v.rel=_?"stylesheet":st,_||(v.as="script"),v.crossOrigin="",v.href=g,l&&v.setAttribute("nonce",l),document.head.appendChild(v),_)return new Promise((o,y)=>{v.addEventListener("load",o),v.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${g}`)))})}))}function s(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return n.then(i=>{for(const c of i||[])c.status==="rejected"&&s(c.reason);return e().catch(s)})};class m{constructor(e,t,r,n,s){this._legacyCanvasSize=m.DEFAULT_CANVAS_SIZE,this._preferredCamera="environment",this._maxScansPerSecond=25,this._lastScanTimestamp=-1,this._destroyed=this._flashOn=this._paused=this._active=!1,this.$video=e,this.$canvas=document.createElement("canvas"),r&&typeof r=="object"?this._onDecode=t:(console.warn(r||n||s?"You're using a deprecated version of the QrScanner constructor which will be removed in the future":"Note that the type of the scan result passed to onDecode will change in the future. To already switch to the new api today, you can pass returnDetailedScanResult: true."),this._legacyOnDecode=t),t=typeof r=="object"?r:{},this._onDecodeError=t.onDecodeError||(typeof r=="function"?r:this._onDecodeError),this._calculateScanRegion=t.calculateScanRegion||(typeof n=="function"?n:this._calculateScanRegion),this._preferredCamera=t.preferredCamera||s||this._preferredCamera,this._legacyCanvasSize=typeof r=="number"?r:typeof n=="number"?n:this._legacyCanvasSize,this._maxScansPerSecond=t.maxScansPerSecond||this._maxScansPerSecond,this._onPlay=this._onPlay.bind(this),this._onLoadedMetaData=this._onLoadedMetaData.bind(this),this._onVisibilityChange=this._onVisibilityChange.bind(this),this._updateOverlay=this._updateOverlay.bind(this),e.disablePictureInPicture=!0,e.playsInline=!0,e.muted=!0;let i=!1;if(e.hidden&&(e.hidden=!1,i=!0),document.body.contains(e)||(document.body.appendChild(e),i=!0),r=e.parentElement,t.highlightScanRegion||t.highlightCodeOutline){if(n=!!t.overlay,this.$overlay=t.overlay||document.createElement("div"),s=this.$overlay.style,s.position="absolute",s.display="none",s.pointerEvents="none",this.$overlay.classList.add("scan-region-highlight"),!n&&t.highlightScanRegion){this.$overlay.innerHTML='<svg class="scan-region-highlight-svg" viewBox="0 0 238 238" preserveAspectRatio="none" style="position:absolute;width:100%;height:100%;left:0;top:0;fill:none;stroke:#e9b213;stroke-width:4;stroke-linecap:round;stroke-linejoin:round"><path d="M31 2H10a8 8 0 0 0-8 8v21M207 2h21a8 8 0 0 1 8 8v21m0 176v21a8 8 0 0 1-8 8h-21m-176 0H10a8 8 0 0 1-8-8v-21"/></svg>';try{this.$overlay.firstElementChild.animate({transform:["scale(.98)","scale(1.01)"]},{duration:400,iterations:1/0,direction:"alternate",easing:"ease-in-out"})}catch{}r.insertBefore(this.$overlay,this.$video.nextSibling)}t.highlightCodeOutline&&(this.$overlay.insertAdjacentHTML("beforeend",'<svg class="code-outline-highlight" preserveAspectRatio="none" style="display:none;width:100%;height:100%;fill:none;stroke:#e9b213;stroke-width:5;stroke-dasharray:25;stroke-linecap:round;stroke-linejoin:round"><polygon/></svg>'),this.$codeOutlineHighlight=this.$overlay.lastElementChild)}this._scanRegion=this._calculateScanRegion(e),requestAnimationFrame(()=>{let c=window.getComputedStyle(e);c.display==="none"&&(e.style.setProperty("display","block","important"),i=!0),c.visibility!=="visible"&&(e.style.setProperty("visibility","visible","important"),i=!0),i&&(console.warn("QrScanner has overwritten the video hiding style to avoid Safari stopping the playback."),e.style.opacity="0",e.style.width="0",e.style.height="0",this.$overlay&&this.$overlay.parentElement&&this.$overlay.parentElement.removeChild(this.$overlay),delete this.$overlay,delete this.$codeOutlineHighlight),this.$overlay&&this._updateOverlay()}),e.addEventListener("play",this._onPlay),e.addEventListener("loadedmetadata",this._onLoadedMetaData),document.addEventListener("visibilitychange",this._onVisibilityChange),window.addEventListener("resize",this._updateOverlay),this._qrEnginePromise=m.createQrEngine()}static set WORKER_PATH(e){console.warn("Setting QrScanner.WORKER_PATH is not required and not supported anymore. Have a look at the README for new setup instructions.")}static async hasCamera(){try{return!!(await m.listCameras(!1)).length}catch{return!1}}static async listCameras(e=!1){if(!navigator.mediaDevices)return[];let t=async()=>(await navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="videoinput"),r;try{e&&(await t()).every(n=>!n.label)&&(r=await navigator.mediaDevices.getUserMedia({audio:!1,video:!0}))}catch{}try{return(await t()).map((n,s)=>({id:n.deviceId,label:n.label||(s===0?"Default Camera":`Camera ${s+1}`)}))}finally{r&&(console.warn("Call listCameras after successfully starting a QR scanner to avoid creating a temporary video stream"),m._stopVideoStream(r))}}async hasFlash(){let e;try{if(this.$video.srcObject){if(!(this.$video.srcObject instanceof MediaStream))return!1;e=this.$video.srcObject}else e=(await this._getCameraStream()).stream;return"torch"in e.getVideoTracks()[0].getSettings()}catch{return!1}finally{e&&e!==this.$video.srcObject&&(console.warn("Call hasFlash after successfully starting the scanner to avoid creating a temporary video stream"),m._stopVideoStream(e))}}isFlashOn(){return this._flashOn}async toggleFlash(){this._flashOn?await this.turnFlashOff():await this.turnFlashOn()}async turnFlashOn(){if(!this._flashOn&&!this._destroyed&&(this._flashOn=!0,this._active&&!this._paused))try{if(!await this.hasFlash())throw"No flash available";await this.$video.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:!0}]})}catch(e){throw this._flashOn=!1,e}}async turnFlashOff(){this._flashOn&&(this._flashOn=!1,await this._restartVideoStream())}destroy(){this.$video.removeEventListener("loadedmetadata",this._onLoadedMetaData),this.$video.removeEventListener("play",this._onPlay),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("resize",this._updateOverlay),this._destroyed=!0,this._flashOn=!1,this.stop(),m._postWorkerMessage(this._qrEnginePromise,"close")}async start(){if(this._destroyed)throw Error("The QR scanner can not be started as it had been destroyed.");if((!this._active||this._paused)&&(window.location.protocol!=="https:"&&console.warn("The camera stream is only accessible if the page is transferred via https."),this._active=!0,!document.hidden))if(this._paused=!1,this.$video.srcObject)await this.$video.play();else try{let{stream:e,facingMode:t}=await this._getCameraStream();!this._active||this._paused?m._stopVideoStream(e):(this._setVideoMirror(t),this.$video.srcObject=e,await this.$video.play(),this._flashOn&&(this._flashOn=!1,this.turnFlashOn().catch(()=>{})))}catch(e){if(!this._paused)throw this._active=!1,e}}stop(){this.pause(),this._active=!1}async pause(e=!1){if(this._paused=!0,!this._active)return!0;this.$video.pause(),this.$overlay&&(this.$overlay.style.display="none");let t=()=>{this.$video.srcObject instanceof MediaStream&&(m._stopVideoStream(this.$video.srcObject),this.$video.srcObject=null)};return e?(t(),!0):(await new Promise(r=>setTimeout(r,300)),this._paused?(t(),!0):!1)}async setCamera(e){e!==this._preferredCamera&&(this._preferredCamera=e,await this._restartVideoStream())}static async scanImage(e,t,r,n,s=!1,i=!1){let c,d=!1;t&&("scanRegion"in t||"qrEngine"in t||"canvas"in t||"disallowCanvasResizing"in t||"alsoTryWithoutScanRegion"in t||"returnDetailedScanResult"in t)?(c=t.scanRegion,r=t.qrEngine,n=t.canvas,s=t.disallowCanvasResizing||!1,i=t.alsoTryWithoutScanRegion||!1,d=!0):console.warn(t||r||n||s||i?"You're using a deprecated api for scanImage which will be removed in the future.":"Note that the return type of scanImage will change in the future. To already switch to the new api today, you can pass returnDetailedScanResult: true."),t=!!r;try{let l,g;[r,l]=await Promise.all([r||m.createQrEngine(),m._loadImage(e)]),[n,g]=m._drawToCanvas(l,c,n,s);let _;if(r instanceof Worker){let u=r;t||m._postWorkerMessageSync(u,"inversionMode","both"),_=await new Promise((h,v)=>{let o,y,w,C=-1;y=k=>{k.data.id===C&&(u.removeEventListener("message",y),u.removeEventListener("error",w),clearTimeout(o),k.data.data!==null?h({data:k.data.data,cornerPoints:m._convertPoints(k.data.cornerPoints,c)}):v(m.NO_QR_CODE_FOUND))},w=k=>{u.removeEventListener("message",y),u.removeEventListener("error",w),clearTimeout(o),v("Scanner error: "+(k?k.message||k:"Unknown Error"))},u.addEventListener("message",y),u.addEventListener("error",w),o=setTimeout(()=>w("timeout"),1e4);let q=g.getImageData(0,0,n.width,n.height);C=m._postWorkerMessageSync(u,"decode",q,[q.data.buffer])})}else _=await Promise.race([new Promise((u,h)=>window.setTimeout(()=>h("Scanner error: timeout"),1e4)),(async()=>{try{var[u]=await r.detect(n);if(!u)throw m.NO_QR_CODE_FOUND;return{data:u.rawValue,cornerPoints:m._convertPoints(u.cornerPoints,c)}}catch(h){if(u=h.message||h,/not implemented|service unavailable/.test(u))return m._disableBarcodeDetector=!0,m.scanImage(e,{scanRegion:c,canvas:n,disallowCanvasResizing:s,alsoTryWithoutScanRegion:i});throw`Scanner error: ${u}`}})()]);return d?_:_.data}catch(l){if(!c||!i)throw l;let g=await m.scanImage(e,{qrEngine:r,canvas:n,disallowCanvasResizing:s});return d?g:g.data}finally{t||m._postWorkerMessage(r,"close")}}setGrayscaleWeights(e,t,r,n=!0){m._postWorkerMessage(this._qrEnginePromise,"grayscaleWeights",{red:e,green:t,blue:r,useIntegerApproximation:n})}setInversionMode(e){m._postWorkerMessage(this._qrEnginePromise,"inversionMode",e)}static async createQrEngine(e){if(e&&console.warn("Specifying a worker path is not required and not supported anymore."),e=()=>it(()=>import("./qr-scanner-worker.min-D85Z9gVD.js"),[],import.meta.url).then(r=>r.createWorker()),!(!m._disableBarcodeDetector&&"BarcodeDetector"in window&&BarcodeDetector.getSupportedFormats&&(await BarcodeDetector.getSupportedFormats()).includes("qr_code")))return e();let t=navigator.userAgentData;return t&&t.brands.some(({brand:r})=>/Chromium/i.test(r))&&/mac ?OS/i.test(t.platform)&&await t.getHighEntropyValues(["architecture","platformVersion"]).then(({architecture:r,platformVersion:n})=>/arm/i.test(r||"arm")&&13<=parseInt(n||"13")).catch(()=>!0)?e():new BarcodeDetector({formats:["qr_code"]})}_onPlay(){this._scanRegion=this._calculateScanRegion(this.$video),this._updateOverlay(),this.$overlay&&(this.$overlay.style.display=""),this._scanFrame()}_onLoadedMetaData(){this._scanRegion=this._calculateScanRegion(this.$video),this._updateOverlay()}_onVisibilityChange(){document.hidden?this.pause():this._active&&this.start()}_calculateScanRegion(e){let t=Math.round(.6666666666666666*Math.min(e.videoWidth,e.videoHeight));return{x:Math.round((e.videoWidth-t)/2),y:Math.round((e.videoHeight-t)/2),width:t,height:t,downScaledWidth:this._legacyCanvasSize,downScaledHeight:this._legacyCanvasSize}}_updateOverlay(){requestAnimationFrame(()=>{if(this.$overlay){var e=this.$video,t=e.videoWidth,r=e.videoHeight,n=e.offsetWidth,s=e.offsetHeight,i=e.offsetLeft,c=e.offsetTop,d=window.getComputedStyle(e),l=d.objectFit,g=t/r,_=n/s;switch(l){case"none":var u=t,h=r;break;case"fill":u=n,h=s;break;default:(l==="cover"?g>_:g<_)?(h=s,u=h*g):(u=n,h=u/g),l==="scale-down"&&(u=Math.min(u,t),h=Math.min(h,r))}var[v,o]=d.objectPosition.split(" ").map((w,C)=>{const q=parseFloat(w);return w.endsWith("%")?(C?s-h:n-u)*q/100:q});d=this._scanRegion.width||t,_=this._scanRegion.height||r,l=this._scanRegion.x||0;var y=this._scanRegion.y||0;g=this.$overlay.style,g.width=`${d/t*u}px`,g.height=`${_/r*h}px`,g.top=`${c+o+y/r*h}px`,r=/scaleX\(-1\)/.test(e.style.transform),g.left=`${i+(r?n-v-u:v)+(r?t-l-d:l)/t*u}px`,g.transform=e.style.transform}})}static _convertPoints(e,t){if(!t)return e;let r=t.x||0,n=t.y||0,s=t.width&&t.downScaledWidth?t.width/t.downScaledWidth:1;t=t.height&&t.downScaledHeight?t.height/t.downScaledHeight:1;for(let i of e)i.x=i.x*s+r,i.y=i.y*t+n;return e}_scanFrame(){!this._active||this.$video.paused||this.$video.ended||("requestVideoFrameCallback"in this.$video?this.$video.requestVideoFrameCallback.bind(this.$video):requestAnimationFrame)(async()=>{if(!(1>=this.$video.readyState)){var e=Date.now()-this._lastScanTimestamp,t=1e3/this._maxScansPerSecond;e<t&&await new Promise(n=>setTimeout(n,t-e)),this._lastScanTimestamp=Date.now();try{var r=await m.scanImage(this.$video,{scanRegion:this._scanRegion,qrEngine:this._qrEnginePromise,canvas:this.$canvas})}catch(n){if(!this._active)return;this._onDecodeError(n)}!m._disableBarcodeDetector||await this._qrEnginePromise instanceof Worker||(this._qrEnginePromise=m.createQrEngine()),r?(this._onDecode?this._onDecode(r):this._legacyOnDecode&&this._legacyOnDecode(r.data),this.$codeOutlineHighlight&&(clearTimeout(this._codeOutlineHighlightRemovalTimeout),this._codeOutlineHighlightRemovalTimeout=void 0,this.$codeOutlineHighlight.setAttribute("viewBox",`${this._scanRegion.x||0} ${this._scanRegion.y||0} ${this._scanRegion.width||this.$video.videoWidth} ${this._scanRegion.height||this.$video.videoHeight}`),this.$codeOutlineHighlight.firstElementChild.setAttribute("points",r.cornerPoints.map(({x:n,y:s})=>`${n},${s}`).join(" ")),this.$codeOutlineHighlight.style.display="")):this.$codeOutlineHighlight&&!this._codeOutlineHighlightRemovalTimeout&&(this._codeOutlineHighlightRemovalTimeout=setTimeout(()=>this.$codeOutlineHighlight.style.display="none",100))}this._scanFrame()})}_onDecodeError(e){e!==m.NO_QR_CODE_FOUND&&console.log(e)}async _getCameraStream(){if(!navigator.mediaDevices)throw"Camera not found.";let e=/^(environment|user)$/.test(this._preferredCamera)?"facingMode":"deviceId",t=[{width:{min:1024}},{width:{min:768}},{}],r=t.map(n=>Object.assign({},n,{[e]:{exact:this._preferredCamera}}));for(let n of[...r,...t])try{let s=await navigator.mediaDevices.getUserMedia({video:n,audio:!1}),i=this._getFacingMode(s)||(n.facingMode?this._preferredCamera:this._preferredCamera==="environment"?"user":"environment");return{stream:s,facingMode:i}}catch{}throw"Camera not found."}async _restartVideoStream(){let e=this._paused;await this.pause(!0)&&!e&&this._active&&await this.start()}static _stopVideoStream(e){for(let t of e.getTracks())t.stop(),e.removeTrack(t)}_setVideoMirror(e){this.$video.style.transform="scaleX("+(e==="user"?-1:1)+")"}_getFacingMode(e){return(e=e.getVideoTracks()[0])?/rear|back|environment/i.test(e.label)?"environment":/front|user|face/i.test(e.label)?"user":null:null}static _drawToCanvas(e,t,r,n=!1){r=r||document.createElement("canvas");let s=t&&t.x?t.x:0,i=t&&t.y?t.y:0,c=t&&t.width?t.width:e.videoWidth||e.width,d=t&&t.height?t.height:e.videoHeight||e.height;return n||(n=t&&t.downScaledWidth?t.downScaledWidth:c,t=t&&t.downScaledHeight?t.downScaledHeight:d,r.width!==n&&(r.width=n),r.height!==t&&(r.height=t)),t=r.getContext("2d",{alpha:!1}),t.imageSmoothingEnabled=!1,t.drawImage(e,s,i,c,d,0,0,r.width,r.height),[r,t]}static async _loadImage(e){if(e instanceof Image)return await m._awaitImageLoad(e),e;if(e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof SVGImageElement||"OffscreenCanvas"in window&&e instanceof OffscreenCanvas||"ImageBitmap"in window&&e instanceof ImageBitmap)return e;if(e instanceof File||e instanceof Blob||e instanceof URL||typeof e=="string"){let t=new Image;t.src=e instanceof File||e instanceof Blob?URL.createObjectURL(e):e.toString();try{return await m._awaitImageLoad(t),t}finally{(e instanceof File||e instanceof Blob)&&URL.revokeObjectURL(t.src)}}else throw"Unsupported image type."}static async _awaitImageLoad(e){e.complete&&e.naturalWidth!==0||await new Promise((t,r)=>{let n=s=>{e.removeEventListener("load",n),e.removeEventListener("error",n),s instanceof ErrorEvent?r("Image load error"):t()};e.addEventListener("load",n),e.addEventListener("error",n)})}static async _postWorkerMessage(e,t,r,n){return m._postWorkerMessageSync(await e,t,r,n)}static _postWorkerMessageSync(e,t,r,n){if(!(e instanceof Worker))return-1;let s=m._workerMessageId++;return e.postMessage({id:s,type:t,data:r},n),s}}m.DEFAULT_CANVAS_SIZE=400;m.NO_QR_CODE_FOUND="No QR code found";m._disableBarcodeDetector=!1;m._workerMessageId=0;m.WORKER_PATH=new URL(""+new URL("qr-scanner-worker.min-PJMWJc5V.js",import.meta.url).href,import.meta.url).toString();const ct=de("video"),z=T(({onResult:a})=>{z.updates(l=>{[{onResult:a}]=l,a=D(a)}),a=D(a);let e=null,t="Idle.",r="";const n=`qrPreview-${Math.random().toString(36).slice(2,9)}`,s=l=>{console.log("[qr] status:",l),t=l},i=()=>{e&&(console.log("[qr] stop"),e.stop(),e.destroy(),e=null,s("Camera stopped."))},c=he(l=>{console.log("[qr] decode result:",l),r=(l==null?void 0:l.data)||"",s("QR detected."),a(r)}),d=async()=>{try{console.log("[qr] start"),s("Requesting camera access...");const l=await new Promise((g,_)=>{let u=0;const h=()=>{const v=document.getElementById(n);if(v)return g(v);if(u+=1,u>30)return _(new Error("QR preview element not found"));requestAnimationFrame(h)};h()});console.log("[qr] preview element:",l),e=new m(l,c,{highlightScanRegion:!0,highlightCodeOutline:!0,preferredCamera:"environment"}),console.log("[qr] scanner created:",e),await e.start(),console.log("[qr] scanner started"),s("Scanning...")}catch(l){console.error("[qr] camera error:",l),s(`Camera error: ${l.message||l}`)}};return T.onDestroy(()=>{i(),console.log("ðŸ”´ stop scanner")}),ue(()=>{d()}),f({class:"qr-panel"},f({class:"qr-preview"},ct({id:n,playsInline:!0,muted:!0})),f({class:"qr-output"},O({class:"qr-label"},"QR Text"),pe({class:"qr-text"},()=>r||"(no scan yet)")),f({class:"qr-status"},()=>t))}),x=T(({title:a,onClose:e,onApply:t,applyLabel:r,ScannerPanel:n})=>{x.updates(h=>{[{title:a,onClose:e,onApply:t,applyLabel:r,ScannerPanel:n}]=h,e=D(e),t&&(t=D(t)),typeof n!="function"&&(n=z)}),e=D(e),t&&(t=D(t)),typeof n!="function"&&(n=z);const s=`qr-modal-${Math.random().toString(36).slice(2,9)}`,i=()=>{const h=document.getElementById(s);h!=null&&h.close&&h.close()};let c="";const d=h=>{c=h||"",t(c)},l=()=>{t&&t(c),i()};return Ae({id:s,class:"qr-modal",open:!0,onClick:h=>{h.target.nodeName==="DIALOG"&&i()},onClose:()=>{e()},onCancel:h=>{h!=null&&h.preventDefault&&h.preventDefault(),i()}},f({class:"qr-modal-card"},f({class:"qr-modal-header"},ge({class:"qr-modal-title"},a),f({class:"qr-modal-actions"},h=>c&&S({type:"button",class:"qr-modal-apply",onClick:l},r||"Apply"),S({type:"button",class:"qr-modal-close","aria-label":"Close",onClick:()=>i()},"Close"))),f({class:"qr-modal-body"},h=>n({onResult:d}))))}),lt=de("video"),Z=T(({onResult:a})=>{Z.updates(o=>{[{onResult:a}]=o,a=D(a)}),a=D(a);let e="Idle.",t="",r="",n=null,s=null,i=null;const c=`barcodePreview-${Math.random().toString(36).slice(2,9)}`,d=o=>{console.log("[barcode] status:",o),e=o},l=(o,y)=>{t=o,r=y||""},g=()=>{i&&(cancelAnimationFrame(i),i=null),s&&(s.getTracks().forEach(o=>o.stop()),s=null),n=null,d("Camera stopped.")},_=he(o=>{a(o)}),u=async o=>{if(!(!n||!s)){try{if(o.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA){const y=await n.detect(o);if(y.length>0){const[w]=y,C=w.rawValue||"",q=w.format||"";C&&_(C),l(C||"(no data)",q),d("Barcode detected.")}else d("Scanning...")}}catch(y){d(`Scan error: ${y.message||y}`)}i=requestAnimationFrame(()=>u(o))}},h=async()=>{if(!("BarcodeDetector"in window)){d("BarcodeDetector API is not supported in this browser.");return}try{d("Requesting camera access...");const o=await new Promise((y,w)=>{let C=0;const q=()=>{const k=document.getElementById(c);if(k)return y(k);if(C+=1,C>30)return w(new Error("Barcode preview element not found"));requestAnimationFrame(q)};q()});n=new BarcodeDetector({formats:["code_128","code_39","code_93","ean_13","ean_8","itf","upc_a","upc_e","qr_code"]}),s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1}),o.srcObject=s,await o.play(),d("Scanning..."),u(o)}catch(o){console.error("[barcode] camera error:",o),d(`Camera error: ${o.message||o}`),g()}};T.onDestroy(()=>{g(),console.log("ðŸ”´ stop barcode scanner")}),ue(()=>{h()});const v=()=>t?r?`${t}

format: ${r}`:t:"";return f({class:"qr-panel"},f({class:"qr-preview"},lt({id:c,playsInline:!0,muted:!0})),f({class:"qr-output"},O({class:"qr-label"},"Barcode Data"),pe({class:"qr-text"},()=>v()||"(no scan yet)")),f({class:"qr-status"},()=>e))}),_e=["PETG","PLA","TPU"],F=["Fireguys","Apples"],ve=a=>/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(a),I=(a,e,t)=>{a[e]=t},dt=a=>{if(!a)return"";try{return new URL(a).hostname.replace(/^www\./,"")}catch{return a.replace(/^https?:\/\//,"").split("/")[0]}},E=(a,e,{trim:t=!1}={})=>({onChange:r=>I(a,e,t?r.target.value.trim():r.target.value),onKeyup:r=>I(a,e,t?r.target.value.trim():r.target.value)}),V=(a,e)=>({onChange:t=>I(a,e,t.target.value),onKeyup:t=>I(a,e,t.target.value)}),j=(a,e)=>({onChange:t=>{var r;return I(a,e,((r=t==null?void 0:t.target)==null?void 0:r.value)||"")}}),we=T((a,e,t,r,n,s)=>{we.updates(o=>{[a,e,t,r,n,s]=o}),t=D(t);let i=!1,c=!1,d=!1;const l=()=>{d=!0},g=()=>{d=!0},_=()=>{if(!n||!d)return;const o=n(),y=()=>{d=!1,t(e)};if(o&&typeof o.then=="function"){o.then(y);return}y()},u=()=>{s&&s(e)},h=o=>{const y=fe(o||"");a.qr_search_data=y||o||"",i=!1,l()},v=o=>{const y=ye(o||"");a.barcode_search_data=y||o||"",c=!1,l()};return f.class`swatch-card`(o=>i&&x({title:"Scan QR for this spool",onClose:()=>i=!1,onApply:h,applyLabel:"Apply QR"}),o=>c&&x({title:"Scan barcode for this spool",onClose:()=>c=!1,onApply:v,applyLabel:"Apply barcode",ScannerPanel:Z}),f.class`edit-card-header`(O.class`edit-card-title`(o=>`Swatch ${a.number||"-"}`),f.class`edit-card-actions`(n?S.type`button`.class`add-button`.disabled(o=>!d).onClick(_)("ðŸ’¾ Save"):null,s?S.type`button`.class`ghost-button`.onClick(u)("ðŸ§¬ Duplicate"):null,S.type`button`.class`edit-card-toggle`.onClick(()=>t(e)).attr("aria-label","Stop editing swatch")("Done"))),L("Number",M.type`number`.value(o=>a.number??"").onChange(V(a,"number").onChange).onKeyup(V(a,"number").onKeyup)()),f.class`fields`.onInput(g).onChange(g).onKeydown(o=>{o.key==="Enter"&&(o.preventDefault(),_())})(L("Hex Color",f.class`hex-input-row`(M.type`color`.value(o=>ve(a.hex)?a.hex:"#000000").style`width:56px; min-width:56px; padding:0; height:42px;`.onChange(o=>{l(),I(a,"hex",o.target.value.trim())})(),M.value(o=>a.hex??"").style`flex:1;`.onChange(E(a,"hex",{trim:!0}).onChange).onKeyup(E(a,"hex",{trim:!0}).onKeyup)())),L("Spool Inventory",M.type`number`.value(o=>a.spool_inventory??"").onChange(V(a,"spool_inventory").onChange).onKeyup(V(a,"spool_inventory").onKeyup)()),L("Label",M.value(o=>a.label??"").onChange(E(a,"label").onChange).onKeyup(E(a,"label").onKeyup)()),L("Manufacturer",P.onChange(j(a,"manufacturer").onChange)($.value``.selected(o=>!a.manufacturer)("Select manufacturer"),...(r||[]).map(o=>$.value(o).selected(y=>a.manufacturer===o)(o)))),L("Material Type",P.onChange(j(a,"material_type").onChange)($.value``.selected(o=>!a.material_type)("Select material"),..._e.map(o=>$.value(o).selected(y=>a.material_type===o)(o)))),L("Location",P.onChange(j(a,"location").onChange)($.value``.selected(o=>!a.location)("Select location"),...F.map(o=>$.value(o).selected(y=>a.location===o)(o)))),L("Color name",M.value(o=>a.color_name??"").onChange(E(a,"color_name").onChange).onKeyup(E(a,"color_name").onKeyup)()),L("Swatch code",M.value(o=>a.swatch_code??"").onChange(E(a,"swatch_code").onChange).onKeyup(E(a,"swatch_code").onKeyup)()),L("QR Search Data",f.class`qr-input-row`(M.class`qr-edit-input`.value(o=>a.qr_search_data??"").onChange(E(a,"qr_search_data").onChange).onKeyup(E(a,"qr_search_data").onKeyup)(),S.type`button`.class`qr-scan-button`.onClick(()=>i=!0)("Scan QR"))),L("Bar Code",f.class`qr-input-row`(M.class`qr-edit-input`.value(o=>a.barcode_search_data??"").onChange(E(a,"barcode_search_data").onChange).onKeyup(E(a,"barcode_search_data").onKeyup)(),S.type`button`.class`qr-scan-button`.onClick(()=>c=!0)("Scan barcode"))),L("URL",M.type`url`.value(o=>a.url??"").onChange(E(a,"url").onChange).onKeyup(E(a,"url").onKeyup)())))}),Se=T((a,e,t,r)=>{Se.updates(s=>{[a,e,t,r]=s}),t=D(t);const n=(s,i)=>{const c=Number(a.spool_inventory),d=Math.max(0,(Number.isFinite(c)?c:0)+i);if(a.spool_inventory=d,s!=null&&s.currentTarget){const l=s.currentTarget;l.classList.add("is-clicked"),window.setTimeout(()=>l.classList.remove("is-clicked"),220)}if(r){const l=r();l&&typeof l.then=="function"&&l.catch(()=>{})}};return f.class`summary-row`(f(s=>a.number||"-"),f.class`summary-swatch`(f.class`summary-chip`.style(s=>`background:${ve(a.hex)?a.hex:""};`)(),O.class`summary-swatch-name`(s=>a.color_name||"Unnamed")),f.class`summary-details`(f.class`summary-title-row`(K(s=>a.label||"Untitled"),S.type`button`.class`summary-edit-button`.onClick(()=>{t(e)})({"aria-label":"Edit swatch"},"âœï¸")),s=>{const i=[];if(a.manufacturer?i.push(O.class`summary-meta-item`(`Maker: ${a.manufacturer}`)):i.push(O.class`summary-meta-item`("Maker: N/A")),i.push(O.class`summary-meta-item summary-spool-meta`(O.class`summary-spool-label`("Spools:"),O.class`summary-spool-count`(c=>{const d=Number(a.spool_inventory);return Number.isFinite(d)?d:0}),f.class`summary-spool-controls`(S.type`button`.class`spool-adjust-button`.attr("aria-label","Decrease spool count").onClick(c=>n(c,-1))("âˆ’"),S.type`button`.class`spool-adjust-button`.attr("aria-label","Increase spool count").onClick(c=>n(c,1))("+")))),a.url){const c=dt(a.url);i.push(O.class`summary-meta-item`(Fe.href(a.url).attr("target","_blank").attr("rel","noopener noreferrer")(c||a.url)))}return i.length?f.class`summary-meta`(...i):""}))}),Ce=T((a,e,t,r,n,s,i)=>(Ce.updates(c=>{[a,e,t,r,n,s,i]=c,r=D(r)}),r=D(r),Pe(c=>t===e?we(a,e,r,n,s,i):Se(a,e,r,s))));let U=null;const ht=a=>{U=U===a?null:a},se=a=>{U=a},be=T((a,e,t)=>{be.updates(p=>{[a,e,t]=p});let r=[],n=!1,s=!1;const i=()=>{r.unshift(mt(F[0]||"")),se(0)},c=()=>_t(r),d=p=>{const b=r[p];if(!b)return;const B={...b,number:0,location:b.location||F[0]||""};r.splice(p+1,0,B),se(p+1)};let l=!1,g=!1,_="",u="",h="",v="",o="",y="",w="";const C="__unassigned__",q=p=>{_=p||"",u=fe(_),l=!1},k=p=>{h=ft(p),v=ye(h)||h,g=!1,console.log("app barcode apply",p)},ee=()=>vt(r,{manufacturerFilter:o,materialTypeFilter:y,locationFilter:w,unassignedLocation:C,qrToken:u,barcodeToken:v}),ke=()=>wt(ee(),[...F,"Unassigned"]);return(()=>{if(!re){console.debug("SwatchApp load skipped: no loader provided");return}n||s||(s=!0,console.debug("SwatchApp loading swatches..."),T.promise=re().then(p=>{console.debug("SwatchApp load complete",{count:(p==null?void 0:p.length)||0}),r=ie(p||[]),n=!0}).catch(p=>{console.error("SwatchApp load failed",p),r=ie([]),n=!0}).finally(()=>{s=!1}))})(),[Ie(Be(e,t),He("Swatch Editor"),Ve("Edit swatches in place. Changes are saved directly to Firestore.")),xe(We.class`panel`(f.class`meta`(f.class`controls`(f.class`controls-group`(S({id:"addSwatchButton",class:"add-button",type:"button",onClick:i},"âž• Add swatch"),S({id:"qrSearchButton",class:"add-button",type:"button",onClick:()=>l=!0},"ðŸ“· Search by QR read"),S({id:"barcodeSearchButton",class:"add-button",type:"button",onClick:()=>g=!0},"ðŸ”Ž Search by barcode read")),f.class`controls-group`(P({value:()=>o??"",onChange:p=>{var b;return o=((b=p==null?void 0:p.target)==null?void 0:b.value)||""}},$({value:""},"Filter by manufacturer"),...(a||[]).map(p=>$({value:p},p))),P({value:()=>y??"",onChange:p=>{var b;return y=((b=p==null?void 0:p.target)==null?void 0:b.value)||""}},$({value:""},"Filter by material type"),..._e.map(p=>$({value:p},p))),P({value:()=>w??"",onChange:p=>{var b;return w=((b=p==null?void 0:p.target)==null?void 0:b.value)||""}},$({value:""},"Filter by location"),...F.map(p=>$({value:p},p)),$({value:C},"Unassigned")),f.id`count`(p=>`${ee().length} swatches`)))),p=>l&&x({title:"Search by QR read",onClose:()=>{l=!1},onApply:q,applyLabel:"Apply QR"}),p=>g&&x({title:"Search by barcode read",onClose:()=>g=!1,onApply:k,applyLabel:"Apply barcode",ScannerPanel:Z}),f({class:"qr-search-pill",hidden:()=>!_},O.class`qr-label`("Active QR search"),K.class`qr-value`(()=>_||"(empty)"),S({type:"button",class:"qr-clear-button",onClick:()=>{_="",u=""}},"Clear search")),f({class:"qr-search-pill",hidden:()=>!h},O.class`qr-label`("Active barcode search"),K.class`qr-value`(()=>h||"(empty)"),S({type:"button",class:"qr-clear-button",onClick:()=>{h="",v=""}},"Clear search")),f.id`summaryList`.class`summary-list`(p=>ke().map(([b,B])=>f.class`location-group`(ge.class`location-title`(`${b} (${B.length})`),...B.map(({item:Q,index:$e})=>Ce(Q,$e,U,ht,a,c,d).key(Q.number||Q)))))))]}),ut=a=>F.includes(a)?a:"",pt=a=>(Array.isArray(a)?a:[]).map(e=>({...e,location:ut(e.location)})).sort((e,t)=>(Number(e.number)||0)-(Number(t.number)||0)),gt=a=>a.map(e=>{const t={number:Number(e.number)||0,label:e.label||""};return e.color_name&&(t.color_name=e.color_name),e.manufacturer&&(t.manufacturer=e.manufacturer),e.material_type&&(t.material_type=e.material_type),e.swatch_code&&(t.swatch_code=e.swatch_code),e.qr_search_data&&(t.qr_search_data=e.qr_search_data),e.barcode_search_data&&(t.barcode_search_data=e.barcode_search_data),e.hex&&(t.hex=e.hex),e.url&&(t.url=e.url),e.location&&(t.location=e.location),e.spool_inventory!==void 0&&e.spool_inventory!==""&&(t.spool_inventory=Number(e.spool_inventory)||0),t}),mt=(a="")=>({number:0,label:"",manufacturer:"",material_type:"",color_name:"",swatch_code:"",qr_search_data:"",barcode_search_data:"",hex:"",url:"",spool_inventory:1,location:a}),ft=a=>a?a.trim():"",oe=(a,e)=>!e||(a||"").toLowerCase()===e.toLowerCase(),yt=(a,e,t)=>e?e===t?!a:(a||"").toLowerCase()===e.toLowerCase():!0,ie=a=>{const e=pt(a);return console.debug("Swatches loaded",{count:e.length}),e},_t=a=>Ue(gt(a)).catch(e=>{console.error("Failed to save swatches",e),alert("Save failed. Check the console for details.")}),vt=(a,e)=>a.reduce((t,r,n)=>{const s=oe(r.manufacturer,e.manufacturerFilter),i=oe(r.material_type,e.materialTypeFilter),c=yt(r.location,e.locationFilter,e.unassignedLocation),d=!e.qrToken||at([r],e.qrToken).length>0,l=!e.barcodeToken||nt([r],e.barcodeToken).length>0;return s&&i&&c&&d&&l&&t.push({item:r,index:n}),t},[]),wt=(a,e)=>{const t=new Map;return e.forEach(r=>{t.set(r,[])}),a.forEach(r=>{const n=r.item.location||e[e.length-1];t.has(n)||t.set(n,[]),t.get(n).push(r)}),Array.from(t.entries()).filter(([,r])=>r.length)},G={current:document.getElementById("swatchApp")};let J=me.map(a=>a),R=null,N=!1,X=!1,Y=null;const Ee=()=>Qe().catch(a=>{console.error("Firebase sign-out failed",a),A.error("Sign out failed. Try again.")}),St=T(()=>be(J,Ee,Y)),ce=(a="")=>{if(!G.current||X)return;const e=Je(G);e&&(e.replaceChildren(),Xe(St,e),X=!0)},W=(a,e,t="")=>{je({rootRef:G,status:a,userEmail:e,adminEmail:"",onSignIn:()=>Ye().catch(r=>{console.error("Firebase sign-in failed",r),A.error("Sign in failed. Try again.")}),onSignOut:Ee,setAppMounted:r=>{X=r}})};W("loading","","initial");const le=async(a,e="")=>{if(N=!1,!a){Y=null,R&&(R(),R=null),W("login","","auth:logged-out");return}Y={email:a.email||"",photoURL:a.photoURL||""};let t=!1;try{t=await ze(a.email||"")}catch(r){console.error("Failed to load admin list",r),A.error("Unable to verify access. Check Firestore rules."),W("denied",a.email||"","auth:permissions");return}if(!t){R&&(R(),R=null),A.error(`Signed in as ${a.email||"unknown"} but not authorized.`),W("denied",a.email||"","auth:denied");return}N=!0,R||(R=Ge(r=>{if(Array.isArray(r)&&r.length?J=r:J=me.map(n=>n),N){ce("manufacturers:update");return}})),ce("auth:authorized")},Ct=async()=>{Ne().then(({redirectError:a,redirectResult:e,persistence:t})=>{a&&A.error("Sign-in failed after redirect. Try again."),t.error&&A.error("Safari blocked login storage. Check cookie settings."),e!=null&&e.user&&le(e.user,"redirectResult")}).catch(a=>{console.error("Failed to prepare auth",a),A.error("Sign-in setup failed. Try again.")}),Ke(a=>{le(a,"onAuthChanged")})};Ct();
