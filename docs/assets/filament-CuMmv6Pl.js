import"./version-JERxWKPc.js";import{t as b,o as F,d as u,s as v,l as M,a as w,b as g,i as tt,c as A,e as K,f as nt,n as at,h as ot,m as st,g as et,p as rt,j as lt,k as it,q as ct,r as ut,u as B,v as D,w as dt,x as mt,y as N,z as ft,A as pt,B as yt,C as ht,D as _t}from"./auth-handler-CUxa3Sdo.js";import{d as $}from"./filament-match-utils-DrMPFgTu.js";import{A as bt}from"./AdminNav.tag-BwAcyMET.js";import{m as gt}from"./filter-utils-CsgsWdIu.js";import"./barcode-utils-VHKBp8aY.js";import"./adminNavItems-DuM74EKO.js";const k=["Fireguys","Apples"],H=(n,t)=>({onChange:a=>{var o;n[t]=((o=a==null?void 0:a.target)==null?void 0:o.value)??""},onKeyup:a=>{var o;n[t]=((o=a==null?void 0:a.target)==null?void 0:o.value)??""}}),q=b((n,t,a,o,e,m,l)=>{q.inputs(r=>{[n,t,a,o,e,m,l]=r,o=F(o),e=F(e),m=F(m),l=F(l)});let i=!1;const y=()=>{i=!0},h=()=>{i=!0},f=()=>{if(!e||!i)return;const r=e(),d=()=>{i=!1,o(t,(n==null?void 0:n.location)??"")};if(r&&typeof r.then=="function"){r.then(d);return}d()},I=()=>{m&&m(t)},L=r=>{var C;const d=((C=r==null?void 0:r.target)==null?void 0:C.value)||"";n.location=d,typeof l=="function"&&l(t,d),y()},U=()=>n!=null&&n.filament_type_id?`./filament-types.html?edit=${encodeURIComponent(n.filament_type_id)}`:"./filament-types.html";return u.class`swatch-card`(u.class`edit-card-header`(v.class`edit-card-title`(r=>$(a==null?void 0:a.find(d=>d.filament_type_id===n.filament_type_id))||"Filament inventory")),u.class`fields`.onInput(h).onChange(h).onKeydown(r=>{r.key==="Enter"&&(r.preventDefault(),f())})(M("Filament type",w.onChange(r=>{var d;n.filament_type_id=((d=r==null?void 0:r.target)==null?void 0:d.value)||"",y()})(g.value``.selected(r=>!n.filament_type_id)("Select filament type"),r=>(a||[]).map(d=>g.value(d.filament_type_id).selected(C=>n.filament_type_id===d.filament_type_id)($(d)||d.label||"Unnamed")))),M("ðŸ“ Location",w.onChange(L)(g.value``.selected(r=>!n.location)("Select location"),...k.map(r=>g.value(r).selected(d=>n.location===r)(r).key(r)))),M("Spool Inventory",tt.type`number`.value(r=>n.spool_inventory??"").onChange(H(n,"spool_inventory").onChange).onKeyup(H(n,"spool_inventory").onKeyup)())),u.class`edit-card-footer`(e?A.type`button`.class`add-button`.disabled(r=>!i).onClick(f)("ðŸ’¾ Save"):null,m?A.type`button`.class`ghost-button`.onClick(I)("ðŸ§¬ Duplicate"):null,K.class`ghost-button`.href(r=>U())("âœï¸ Edit filament"),A.type`button`.class`ghost-button`.onClick(()=>o(t,(n==null?void 0:n.location)??"")).attr("aria-label","Stop editing inventory")("Done")))}),Ft=n=>/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(n),vt=n=>{if(!n)return"";try{return new URL(n).hostname.replace(/^www\./,"")}catch{return n.replace(/^https?:\/\//,"").split("/")[0]}},x=b((n,t,a,o,e)=>{x.inputs(l=>{[n,t,a,o,e]=l,o=F(o),e=F(e)});const m=(l,i)=>{const y=Number(n.spool_inventory),h=Math.max(0,(Number.isFinite(y)?y:0)+i);if(n.spool_inventory=h,l!=null&&l.currentTarget){const f=l.currentTarget;f.classList.add("is-clicked"),window.setTimeout(()=>f.classList.remove("is-clicked"),220)}if(e){const f=e();f&&typeof f.then=="function"&&f.catch(()=>{})}};return u.class`summary-row`(u(l=>(t==null?void 0:t.number)||"-"),u.class`summary-swatch`(u.class`summary-chip`.style(l=>`background:${Ft(t==null?void 0:t.hex)?t.hex:""};`)(),v.class`summary-swatch-name`(l=>(t==null?void 0:t.color_name)||"Unnamed")),u.class`summary-details`(u.class`summary-title-row`(nt(l=>(t==null?void 0:t.label)||"Untitled filament"),A.type`button`.class`summary-edit-button`.onClick(()=>{o(a,(n==null?void 0:n.location)??"")})({"aria-label":"Edit inventory entry"},"âœï¸")),l=>{const i=[],y=$(t);y&&i.push(v.class`summary-meta-item`(y));const h=t!=null&&t.material_type?`Material: ${t.material_type}`:"Material: N/A";if(i.push(v.class`summary-meta-item`(h)),i.push(v.class`summary-meta-item summary-spool-meta`(v.class`summary-spool-label`("Spools:"),v.class`summary-spool-count`(f=>{const I=Number(n.spool_inventory);return Number.isFinite(I)?I:0}),u.class`summary-spool-controls`(A.type`button`.class`spool-adjust-button`.attr("aria-label","Decrease spool count").onClick(f=>m(f,-1))("âˆ’"),A.type`button`.class`spool-adjust-button`.attr("aria-label","Increase spool count").onClick(f=>m(f,1))("+")))),t!=null&&t.url){const f=vt(t.url);i.push(v.class`summary-meta-item`(K.href(t.url).attr("target","_blank").attr("rel","noopener noreferrer")(f||t.url)))}return i.length?u.class`summary-meta`(...i):""}))});let p={};const At=(n,t)=>{if(p&&p.index===n&&(t===void 0||p.location===t)){p={};return}p={index:n,location:t??""}},O=(n,t="")=>{if(n==null){p={};return}p={index:n,location:t}},It=(n,t="")=>{!p||p.index!==n||(p={...p,location:t})},P=b((n,t,a,o,e,m,l,i)=>(P.inputs(y=>{[n,t,a,o,e,m,l,i]=y,e=F(e),l=F(l),i=F(i)}),at(y=>o?q(n,a,m,e,l,i,It):x(n,t,a,e,l)))),G=b((n,t)=>{G.updates(s=>{[n,t]=s});let a=[],o=[],e=!1,m=!1,l=!1,i=!1;const y=s=>{var c;a.unshift(Ut(s||k[0]||"",o)),O(0,((c=a[0])==null?void 0:c.location)||"")},h=()=>b.promise=Z(a).then(()=>{delete p.index}),f=s=>{const c=a[s];if(!c)return;const _={...c,location:c.location||k[0]||""};a.splice(s+1,0,_),O(s+1,_.location||"")},I=s=>{const c=a.filter(_=>(_.location||"")===s);c.length&&confirm(`Zero out all spool inventory for ${s}?`)&&(c.forEach(_=>{_.spool_inventory=0}),b.promise=Z(a))};let L="",U="";const r="__unassigned__",d="Unassigned",C=()=>wt(a,o,{filamentTypeFilter:U,locationFilter:L,unassignedLocation:r}),X=()=>$t(C(),[...k,d]),Y=()=>{!B||l||i||(i=!0,b.promise=B().then(s=>{o=Array.isArray(s)?s:[],l=!0}).catch(s=>{console.error("Filament types load failed",s),o=[],l=!0}).finally(()=>{i=!1}))},R=()=>{if(!D){console.debug("FilamentInventoryApp load skipped: no loader provided");return}e||m||(m=!0,console.debug("FilamentInventoryApp loading inventory..."),b.promise=D().then(s=>{console.debug("FilamentInventoryApp load complete",{count:(s==null?void 0:s.length)||0}),a=S(s||[]),e=!0}).catch(s=>{console.error("FilamentInventoryApp load failed",s),a=S([]),e=!0}).finally(()=>{m=!1}))};return Y(),R(),[ot(bt(n,t),et("Filament Inventory"),rt("Edit filament inventory in place. Changes are saved directly to Firestore.")),st(lt.class`panel`(s=>`editIndex:${p==null?void 0:p.index}:`,u.class`meta`(u.class`controls`(u.class`controls-group`(w.value(s=>U??"").onChange(s=>{var c;U=((c=s==null?void 0:s.target)==null?void 0:c.value)||""})(g.value``("Filter by filament type"),...(o||[]).map(s=>g.value(s.filament_type_id)($(s)||s.label||"Untitled"))),w.value(s=>L??"").onChange(s=>{var c;L=((c=s==null?void 0:s.target)==null?void 0:c.value)||""})(g.value``("ðŸ“ Filter by location"),...k.map(s=>g.value(s)(s)),g.value(r)("Unassigned")),u.id`count`(s=>`${C().length} items`)))),u.id`summaryList`.class`summary-list`(s=>X().map(([c,_])=>u.class`location-group`(u.class`location-title-row`(it.class`location-title`(`ðŸ“ ${c} (${_.length})`),c===d?null:u.class`location-actions`(K.class`ghost-button location-fast-edit`.href`./${ct(c)}/fast-edit.html`("âš¡ Fast edit"),A.type`button`.class`add-button`.onClick(()=>y(c))("âž• Add filament"),A.type`button`.class`ghost-button delete-button`.onClick(()=>I(c))("Zero out"))),jt=>_.map(({item:V,index:z,type:T})=>P(V,T,z,(p==null?void 0:p.index)===z,At,o,h,f).key(V.filament_type_id||`item-${z}`))).key(c)))))]}),Ct=n=>k.includes(n)?n:"",kt=n=>(Array.isArray(n)?n:[]).map(t=>({...t,location:Ct(t.location)})),Lt=n=>n.map(t=>{const a={};return t.filament_type_id&&(a.filament_type_id=t.filament_type_id),t.location&&(a.location=t.location),t.spool_inventory!==void 0&&t.spool_inventory!==""&&(a.spool_inventory=Number(t.spool_inventory)||0),a}),Ut=(n="",t=[])=>{var a;return{filament_type_id:((a=t==null?void 0:t[0])==null?void 0:a.filament_type_id)||"",spool_inventory:1,location:n}},S=n=>{const t=kt(n);return console.debug("Filament inventory loaded",{count:t.length}),t},Z=n=>ut(Lt(n)).catch(t=>{console.error("Failed to save filament inventory",t),alert("Save failed. Check the console for details.")}),wt=(n,t,a)=>n.reduce((o,e,m)=>{const l=!a.filamentTypeFilter||e.filament_type_id===a.filamentTypeFilter,i=gt(e.location,a.locationFilter,a.unassignedLocation);if(l&&i){const y=t==null?void 0:t.find(h=>h.filament_type_id===e.filament_type_id);o.push({item:e,index:m,type:y})}return o},[]),$t=(n,t)=>{const a=new Map;return t.forEach(o=>{a.set(o,[])}),n.forEach(o=>{const e=o.item.location||t[t.length-1];a.has(e)||a.set(e,[]),a.get(e).push(o)}),Array.from(a.entries()).filter(([,o])=>o.length)},j={current:document.getElementById("filamentApp")};let E=!1,J=null;const Q=()=>dt().catch(n=>{console.error("Firebase sign-out failed",n),N.error("Sign out failed. Try again.")}),Nt=b(()=>G(Q,J)),zt=(n="")=>{if(!j.current||E)return;const t=ht(j);t&&(t.replaceChildren(),_t(Nt,t),E=!0)},W=(n,t,a="")=>{ft({rootRef:j,status:n,userEmail:t,adminEmail:"",onSignIn:()=>pt().catch(o=>{console.error("Firebase sign-in failed",o),N.error("Sign in failed. Try again.")}),onSignOut:Q,setAppMounted:o=>{E=o}})};W("loading","","initial");const Mt=async(n,t="")=>{await yt({user:n,mountSso:W,toast:N,setCurrentUser:o=>{J=o},onAuthorized:()=>{zt("auth:authorized")},reason:t})};mt({onUser:Mt,toast:N});
