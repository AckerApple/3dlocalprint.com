import"./version-JERxWKPc.js";import{t as ie,w as se,j as ce,d as s,g as de,p as h,c as S,i as D,a as T,b as c,x as ue,y as d,C as J,D as Q,z as ge,A as pe,B as be,Y as fe,Z as he,_ as ye,$ as Y,a0 as A,a1 as me,a2 as w,s as z,R as Ce,k as Se,l as m,a3 as De,a4 as W}from"./auth-handler-CUxa3Sdo.js";import{A as ve}from"./AdminNav.tag-BwAcyMET.js";import"./adminNavItems-DuM74EKO.js";const Ae=["Sales Revenue","Owner Contribution","Filament","Printer Parts","Tools","Packaging","Shipping Expense","Shipping Income","Bank Bonus Income","Marketing","Software","Event Fees","Sales Tax Collected","Other"];let q=document.getElementById("ledgerApp");const b={current:q};let u=[],f=null,$=!1,M=!1,ee=null,k=!0,_=!1,N="create",O="",p=!1,y=!1,R=!1,F=null;const o={search:"",status:"",direction:"",category:"",startDate:"",endDate:""};let x=!1;const P={category:"ledger:lastCategory",direction:"ledger:lastDirection"},B=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),X=(e,t="")=>{try{return window.localStorage.getItem(e)||t}catch{return t}},Z=(e,t)=>{try{window.localStorage.setItem(e,t)}catch{}},te=()=>new Date().toISOString().slice(0,10),we=()=>{var t;if((t=globalThis.crypto)!=null&&t.randomUUID)return crypto.randomUUID();const e=Math.random().toString(36).slice(2,10);return`ledger_${Date.now().toString(36)}_${e}`},j=()=>({title:"",amount:"",direction:X(P.direction,"credit"),billingCategory:X(P.category,""),applicableDate:te(),notes:"",status:"posted"});let n=j();console.log("draft",{draft:n});const K=e=>[...e].sort((t,a)=>{const l=String(t.applicableDate||""),r=String(a.applicableDate||"");return l!==r?r.localeCompare(l):(Number(a.createdAt)||0)-(Number(t.createdAt)||0)}),Ee=e=>B.format(Number(e)||0),L=e=>{const t=Number(e)||0;return t>0?`+${B.format(t)}`:t<0?`-${B.format(Math.abs(t))}`:B.format(0)},Te=e=>({id:String((e==null?void 0:e.id)||""),amount:Number(e==null?void 0:e.amount)||0,direction:(e==null?void 0:e.direction)==="debit"?"debit":"credit",title:String((e==null?void 0:e.title)||""),billingCategory:String((e==null?void 0:e.billingCategory)||""),applicableDate:String((e==null?void 0:e.applicableDate)||""),notes:String((e==null?void 0:e.notes)||""),status:["pending","posted","reconciled"].includes(e==null?void 0:e.status)?e.status:"posted",createdAt:Number(e==null?void 0:e.createdAt)||Date.now(),updatedAt:Number(e==null?void 0:e.updatedAt)||Date.now()}),ke=e=>({title:String(e.title||""),amount:Number(e.amount).toFixed(2),direction:e.direction==="debit"?"debit":"credit",billingCategory:String(e.billingCategory||""),applicableDate:String(e.applicableDate||te()),notes:String(e.notes||""),status:["pending","posted","reconciled"].includes(e.status)?e.status:"posted"}),Le=e=>{if(!/^\d{4}-\d{2}-\d{2}$/.test(e||""))return!1;const t=new Date(`${e}T00:00:00`);return!Number.isNaN(t.getTime())},G=e=>{const t={},a=String(e.title||"").trim(),l=String(e.amount||"").trim(),r=Number(l),g=/^\d+(\.\d{1,2})?$/;return(a.length<2||a.length>80)&&(t.title="Title must be 2-80 characters."),(!g.test(l)||!Number.isFinite(r)||r<=0)&&(t.amount="Amount must be a number greater than 0 (up to 2 decimals)."),["debit","credit"].includes(e.direction)||(t.direction="Choose debit or credit."),String(e.billingCategory||"").trim()||(t.billingCategory="Billing category is required."),Le(e.applicableDate)||(t.applicableDate="Applicable date is required."),["pending","posted","reconciled"].includes(e.status)||(t.status="Status must be pending, posted, or reconciled."),t},Ie=()=>{const e=String(n.title||"").trim(),t=String(n.notes||"").trim(),a=String(n.billingCategory||"").trim();return{title:e,notes:t,billingCategory:a||"",amount:Number(n.amount),direction:n.direction,applicableDate:n.applicableDate,status:n.status}},Ne=()=>{const e=new Set(Ae);return u.forEach(t=>{t.billingCategory&&e.add(t.billingCategory)}),Array.from(e).sort((t,a)=>t.localeCompare(a))},Oe=()=>{const e=new Set;return u.forEach(t=>{t.billingCategory&&e.add(t.billingCategory)}),Array.from(e).sort((t,a)=>t.localeCompare(a))},Fe=()=>{const e=o.search.trim().toLowerCase();return K(u).filter(t=>{const a=!e||t.title.toLowerCase().includes(e)||String(t.notes||"").toLowerCase().includes(e),l=!o.status||t.status===o.status,r=!o.direction||t.direction===o.direction,g=!o.category||t.billingCategory===o.category,v=!o.startDate||t.applicableDate>=o.startDate,oe=!o.endDate||t.applicableDate<=o.endDate;return a&&l&&r&&g&&v&&oe})},i=()=>{if(!b.current)return;const e=J(b);e&&(e.replaceChildren(),Q(ne,e),requestAnimationFrame(()=>{Ue()}),M=!0,q=b.current)},$e=()=>{N="create",O="",n=j(),R=!1,_=!0,i()},Me=e=>{const t=u.find(a=>a.id===e);t&&(N="edit",O=e,n=ke(t),R=!1,_=!0,i())},I=()=>{_=!1,R=!1,p=!1,y=!1,n=j(),i()},V=e=>{const t=Number(e.amount)||0;return e.direction==="debit"?-t:t},Re=()=>{const e=u.reduce((l,r)=>r.status!=="reconciled"?l:l+V(r),0),t=u.reduce((l,r)=>["posted","reconciled"].includes(r.status)?l+V(r):l,0),a=u.reduce((l,r)=>l+V(r),0);F={reconciledTotal:e,postedTotal:t,pendingTotal:a},d.info(`Reconciled: ${L(e)} | Posted: ${L(t)} | Pending: ${L(a)}`),i()},ae=async()=>{if(!$){d.error("Sign in to save changes.");return}R=!0;const e=G(n);if(Object.keys(e).length){i();return}p=!0,i();const t=Ie(),a=Date.now();let l=[];N==="edit"&&O?l=u.map(r=>r.id===O?{...r,...t,updatedAt:a}:r):l=[{id:we(),...t,createdAt:a,updatedAt:a},...u];try{await W(K(l)),Z(P.category,t.billingCategory),Z(P.direction,t.direction),d.success(N==="edit"?"Ledger entry updated.":"Ledger entry added."),I()}catch(r){console.error("Failed to save ledger entries",r),d.error("Save failed. Try again."),p=!1,i()}},xe=async()=>{if(O&&confirm("Delete this ledger entry?")){if(!$){d.error("Sign in to delete entries.");return}y=!0,i();try{const e=u.filter(t=>t.id!==O);await W(e),d.success("Ledger entry deleted."),I()}catch(e){console.error("Failed to delete ledger entry",e),d.error("Delete failed. Try again."),y=!1,i()}}},Be=e=>{var t;((t=e==null?void 0:e.target)==null?void 0:t.nodeName)==="DIALOG"&&I()},Pe=e=>{var t;e.key==="Enter"&&((t=e.target)==null?void 0:t.tagName)!=="TEXTAREA"&&(e.preventDefault(),p||ae())},C=()=>{const e=document.getElementById("ledgerSaveButton");if(!e)return;const t=Object.keys(G(n)).length===0;e.disabled=!t||p||y},U=(e,t)=>{if(e){if(e.classList.remove("ledger-direction-select-credit","ledger-direction-select-debit"),t==="credit"){e.classList.add("ledger-direction-select-credit");return}t==="debit"&&e.classList.add("ledger-direction-select-debit")}},Ue=()=>{U(document.getElementById("ledger-direction"),n.direction),U(document.getElementById("ledger-filter-direction"),o.direction)},re=()=>se().catch(e=>{console.error("Firebase sign-out failed",e),d.error("Sign out failed. Try again.")}),E=(e,t)=>R&&e[t]?h.class`ledger-field-error`(e[t]):null,qe=()=>{if(!_)return null;const e=G(n),t=Object.keys(e).length===0,a=Ne(),l=()=>n.billingCategory==="Other"||!a.includes(String(n.billingCategory||"").trim());return Ce({class:"qr-modal ledger-modal",open:!0,onClick:Be,onCancel:r=>{r.preventDefault(),I()},onKeyDown:Pe},s.class`qr-modal-card ledger-modal-card`(s.class`qr-modal-header`(Se(N==="edit"?"Edit Ledger Entry":"Add Ledger Entry"),s.class`qr-modal-actions`(S.type`button`.class`qr-modal-close`.onClick(I)("Close"))),s.class`ledger-form-grid`(m("Title",D.type`text`.placeholder`Entry title`.value(()=>n.title).onInput(r=>{n.title=r.target.value,C()})(),E(e,"title")),m("Amount",D.type`text`.attr("inputmode","decimal").placeholder`0.00`.value(()=>n.amount).onInput(r=>{n.amount=r.target.value,C()})(),E(e,"amount")),m("Direction",T.id`ledger-direction`.class`ledger-direction-select`.value(()=>n.direction).onChange(r=>{n.direction=r.target.value,C(),U(r.target,n.direction)})(c.value`credit`("+ Credit"),c.value`debit`("- Debit")),E(e,"direction")),m("Applicable Date",D.type`date`.value(()=>n.applicableDate).onChange(r=>{n.applicableDate=r.target.value,C()})(),E(e,"applicableDate")),m("Billing Category",s.class`ledger-category-row`(T.value(()=>n.billingCategory).onChange(r=>{const g=r.target.value;if(g==="Other"){const v=String(n.billingCategory||"").trim();n.billingCategory=a.includes(v)?"Other":v||""}else n.billingCategory=g;C()})(...a.map(r=>c.value(r)(r))),r=>l()&&D.type`text`.placeholder`Custom category`.value(g=>n.billingCategory).onInput(g=>{const v=String(g.target.value||"").trim();n.billingCategory=v||"",C()})),E(e,"billingCategory")),m("Status",T.value(()=>n.status).onChange(r=>{n.status=r.target.value,C()})(c.value`pending`.attr("title","its not hit bank")("â³ Pending"),c.value`posted`.attr("title","its in the bank")("ðŸ¦ Posted"),c.value`reconciled`.attr("title","its on quickbooks and bank")("âœ… Reconciled")),E(e,"status")),m("Notes (optional)",De.class`ledger-notes`.placeholder`Optional notes`.value(()=>n.notes).onInput(r=>{n.notes=r.target.value})())),s.class`ledger-modal-actions`(N==="edit"?S({type:"button",class:"ghost-button delete-button",disabled:y||p,onClick:xe},y?"Deleting...":"Delete"):null,S({type:"button",class:"ghost-button",disabled:y||p,onClick:I},"Cancel"),S({id:"ledgerSaveButton",type:"button",class:"add-button",disabled:!t||p||y,onClick:ae},p?"Saving...":"Save"))))},ne=ie(()=>{const e=Fe(),t=Oe();return[ve(re,ee),ce.class`panel ledger-panel`(s.class`ledger-header`(s.class`ledger-heading`(de("Ledger"),h("Track incoming and outgoing monies in one place.")),s.class`ledger-header-actions`(S.type`button`.class`ghost-button`.onClick(Re)("Calculate Totals"),S.type`button`.class`add-button`.onClick($e)("+ Add Entry"),F===null?null:s.class`ledger-totals`(h.class`ledger-net-value`(`Reconciled total: ${L(F.reconciledTotal)}`),h.class`ledger-net-value`(`Posted total: ${L(F.postedTotal)}`),h.class`ledger-net-value`(`Pending total: ${L(F.pendingTotal)}`)))),s.class`ledger-filters`(s.class`ledger-filters-primary`(D.type`search`.placeholder`Search title or notes`.value(()=>o.search).onInput(a=>{o.search=a.target.value,i()})(),T.value(()=>o.status).onChange(a=>{o.status=a.target.value,i()})(c.value``("All statuses"),c.value`pending`("â³ Pending"),c.value`posted`("ðŸ¦ Posted"),c.value`reconciled`("âœ… Reconciled")),S.type`button`.class`ghost-button`.onClick(()=>{x=!x,i()})(x?"Fewer filters":"More filters")),x?s.class`ledger-filters-advanced`(T.id`ledger-filter-direction`.class`ledger-direction-select`.value(()=>o.direction).onChange(a=>{o.direction=a.target.value,U(a.target,o.direction),i()})(c.value``("All directions"),c.value`credit`("+ Credit"),c.value`debit`("- Debit")),T.value(()=>o.category).onChange(a=>{o.category=a.target.value,i()})(c.value``("All categories"),...t.map(a=>c.value(a)(a))),D.type`date`.value(()=>o.startDate).onChange(a=>{o.startDate=a.target.value,i()})(),D.type`date`.value(()=>o.endDate).onChange(a=>{o.endDate=a.target.value,i()})()):null),k?h("Loading..."):null,!k&&e.length===0?h.class`ledger-empty`("No entries found. Add your first entry."):null,!k&&e.length?[s.class`ledger-table-block`(s.class`ledger-table-wrap`(he.class`ledger-table`(ye(Y(A("Applicable Date"),A("Title"),A("Category"),A("Status"),A("Direction"),A("Amount"))),me(...e.map(a=>Y.class`ledger-row`.onClick(()=>Me(a.id))(w(a.applicableDate||"â€”"),w(z.class`ledger-title-cell`.attr("title",a.title||"â€”")(a.title||"â€”")),w(a.billingCategory||"â€”"),w(z.class`pill ledger-status-pill ${a.status==="pending"?"ledger-status-pending":a.status==="reconciled"?"ledger-status-reconciled":"ledger-status-posted"}`(a.status||"posted")),w(z.class`pill ledger-direction-pill ${a.direction==="debit"?"ledger-direction-debit":"ledger-direction-credit"}`(a.direction==="debit"?"- Debit":"+ Credit")),w(Ee(a.amount))).key(a.id))))),h.class`ledger-table-hint`("tap any row for more details"))]:null),qe()]}),H=()=>{if(!b.current||M)return;const e=J(b);e&&(e.replaceChildren(),Q(ne,e),M=!0,q=b.current)},le=(e,t,a="")=>{b.current&&(ge({rootRef:b,status:e,userEmail:t,adminEmail:"",onSignIn:()=>pe().catch(l=>{console.error("Firebase sign-in failed",l),d.error("Sign in failed. Try again.")}),onSignOut:re,setAppMounted:l=>{M=l}}),q=b.current)};le("loading","","initial");const _e=async(e,t="")=>{$=!1,await be({user:e,mountSso:le,toast:d,setCurrentUser:l=>{ee=l},onSignedOut:()=>{f&&(f(),f=null),k=!0},onDenied:()=>{f&&(f(),f=null),k=!0},onAuthorized:()=>{$=!0,f||(f=fe(l=>{u=K((Array.isArray(l)?l:[]).map(Te)),k=!1,$&&(M?i():H())})),H()},reason:t})};ue({onUser:_e,toast:d});
