import{t as _,q as j,d as i,h as P,e as V,g as z,p as K,j as q,s as A,c as h,f as Y,u as M,a7 as G,y as g,x as H,z as J,A as Q,w as W,B as X,C as Z,D as tt}from"./auth-handler-CUxa3Sdo.js";import{B as et}from"./BarcodeScanner.tag-DHJjCGfw.js";import{e as at}from"./barcode-utils-VHKBp8aY.js";import{d as st,g as ot}from"./filament-match-utils-DrMPFgTu.js";const nt=["code_128","code_39","code_93","ean_13","ean_8","itf","upc_a","upc_e"],rt=1200,ct=()=>{let e=null;const l=(d,u)=>{try{e||(e=new AudioContext),e.state==="suspended"&&e.resume().catch(()=>{});const n=e.createOscillator(),f=e.createGain();n.type="sine",n.frequency.value=d,f.gain.value=.12,n.connect(f),f.connect(e.destination),n.start(),n.stop(e.currentTime+u/1e3)}catch(n){console.warn("Audio tone failed",n)}};return{success:()=>l(880,120),fail:()=>l(220,180)}},it=(e,l)=>{const d=l.toLowerCase(),u=["barcode_search_data","swatch_code","number","label","color_name"];for(const n of u){const f=e.find(y=>{const o=y[n];return Array.isArray(o)?o.some(p=>p==null?void 0:p.toString().toLowerCase().includes(d)):o==null||o===""?!1:o.toString().toLowerCase().includes(d)});if(f)return{type:f,matchKey:ot(f,l)}}return null},I=_((e,l)=>{I.updates(t=>{[e,l]=t}),j(e);const d=ct();let u=[],n=!1,f=!1,y="",o="",p="Choose add or remove to start scanning.",c=[],k={token:"",at:0};const w=()=>{!M||f||n||(f=!0,_.promise=M().then(t=>{u=Array.isArray(t)?t:[],y="",n=!0}).catch(t=>{console.error("Fast edit load failed",t),y="Failed to load filament data.",u=[],n=!0}).finally(()=>{f=!1}))};w();const C=t=>{o=t,p="Scanner active. Point at a barcode."},x=(t,a)=>{if(!a)return;const s=c.find(m=>m.key===a);s?s.count+=1:c.push({key:a,item:t,count:1})},B=t=>{const s=(at(t||"")||t||"").trim();if(!s){p="No barcode data received.",d.fail();return}const m=Date.now();if(s===k.token&&m-k.at<rt)return;k={token:s,at:m};const r=it(u,s);r!=null&&r.type&&(r!=null&&r.matchKey)?(x(r.type,r.matchKey),p=`Matched ${r.type.label||r.type.color_name||"filament"}.`,d.success()):(p=`No match for ${s}.`,d.fail())},F=(t,a)=>{const s=c.find(r=>r.key===t);if(!s)return;const m=s.count+a;if(m<=0){c=c.filter(r=>r.key!==t);return}s.count=m},$=t=>{c=c.filter(a=>a.key!==t)},N=async()=>{if(!o||!c.length)return;const t=c.reduce((a,s)=>{const m=o==="add"?s.count:-s.count;return a[s.key]=(a[s.key]||0)+m,a},{});try{await G({location:e,adjustments:t}),g.success(o==="add"?"Inventory added.":"Inventory removed."),c=[],n=!1,w()}catch(a){console.error("Fast edit update failed",a),g.error("Update failed. Try again.")}},D=o==="add"?"ADD INVENTORY":"REMOVE FROM INVENTORY",S=()=>c.length>0;return i.class`fast-edit-page`(P.class`fast-edit-header`(V({class:"ghost-button fast-edit-back",href:"../index.html"},"← BACK"),i(z("Fast Edit"),K(`Location: ${e||l||"Unknown"}`))),q.class`panel fast-edit-panel`(i.class`fast-edit-mode`(A.class`fast-edit-label`("Mode"),i.class`fast-edit-actions`(h.type`button`.class(t=>`add-button ${o==="add"?"is-active":""}`).onClick(()=>C("add"))("➕ Add"),h.type`button`.class(t=>`add-button ${o==="remove"?"is-active":""}`).onClick(()=>C("remove"))("➖ Remove"))),i.class`fast-edit-status`(t=>p),t=>o?i.class`fast-edit-scanner`(et({onResult:B,formats:nt})):i.class`fast-edit-placeholder`("Select a mode to enable barcode scanning."),t=>y&&i.class`fast-edit-error`(y),t=>S()&&i.class`fast-edit-list`(...c.map(a=>i.class`fast-edit-row`(i.class`fast-edit-row-info`(Y(st(a.item)),A.class`fast-edit-row-meta`(`#${a.item.number||"-"} • ${a.item.material_type||"Material"}`)),i.class`fast-edit-row-count`(h.type`button`.class`spool-adjust-button`.onClick(()=>F(a.key,-1))("−"),A.class`fast-edit-count`(s=>a.count),h.type`button`.class`spool-adjust-button`.onClick(()=>F(a.key,1))("+")),h.type`button`.class`ghost-button fast-edit-remove`.onClick(()=>$(a.key))("Remove")).key(a.key))),t=>S()&&h.type`button`.class`add-button fast-edit-submit`.onClick(()=>N())(D)))}),b={current:document.getElementById("fastEditApp")};var E,R;const lt=((R=(E=b.current)==null?void 0:E.dataset)==null?void 0:R.location)||"";var T,O;const dt=((O=(T=b.current)==null?void 0:T.dataset)==null?void 0:O.locationSlug)||"";let v=!1,L=null;const ut=()=>W().catch(e=>{console.error("Firebase sign-out failed",e),g.error("Sign out failed. Try again.")}),ft=_(()=>I(lt,dt,L)),pt=()=>{if(!b.current||v)return;const e=Z(b);e&&(e.replaceChildren(),tt(ft,e),v=!0)},U=(e,l,d="")=>{J({rootRef:b,status:e,userEmail:l,adminEmail:"",onSignIn:()=>Q().catch(u=>{console.error("Firebase sign-in failed",u),g.error("Sign in failed. Try again.")}),onSignOut:ut,setAppMounted:u=>{v=u}})};U("loading","","initial");const mt=async e=>{await X({user:e,mountSso:U,toast:g,setCurrentUser:d=>{L=d},onAuthorized:()=>{pt()}})};H({onUser:mt,toast:g});
