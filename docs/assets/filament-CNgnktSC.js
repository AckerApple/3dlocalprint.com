import"./version-BKoZn0Lf.js";import{t as v,o as F,d as c,s as b,l as z,a as w,b as h,i as R,c as A,e as B,f as T,n as tt,h as nt,m as at,g as ot,p as st,j as et,k as rt,q as lt,r as it,u as V,v as D,w as ct,x as ut,y as N,z as dt,A as mt,B as pt,C as ft,D as yt}from"./auth-handler-CbhqdzIw.js";import{d as $}from"./filament-match-utils-DrMPFgTu.js";import{A as _t}from"./AdminNav.tag-CZV5rcZC.js";import{m as ht}from"./filter-utils-CsgsWdIu.js";import"./barcode-utils-VHKBp8aY.js";import"./adminNavItems-u5BZOrdS.js";const I=["Fireguys","Apples"],E=(n,t)=>({onChange:a=>{var o;n[t]=((o=a==null?void 0:a.target)==null?void 0:o.value)??""},onKeyup:a=>{var o;n[t]=((o=a==null?void 0:a.target)==null?void 0:o.value)??""}}),q=v((n,t,a,o,r,d,l)=>{q.inputs(e=>{[n,t,a,o,r,d,l]=e,o=F(o),r=F(r),d=F(d),l=F(l)});let i=!1;const f=()=>{i=!0},_=()=>{i=!0},m=()=>{if(!r||!i)return;const e=r(),u=()=>{i=!1,o(t,(n==null?void 0:n.location)??"")};if(e&&typeof e.then=="function"){e.then(u);return}u()},g=()=>{d&&d(t)},C=e=>{var k;const u=((k=e==null?void 0:e.target)==null?void 0:k.value)||"";n.location=u,typeof l=="function"&&l(t,u),f()},U=()=>n!=null&&n.filament_type_id?`./filament-types.html?edit=${encodeURIComponent(n.filament_type_id)}`:"./filament-types.html";return c.class`swatch-card`(c.class`edit-card-header`(b.class`edit-card-title`(e=>$(a==null?void 0:a.find(u=>u.filament_type_id===n.filament_type_id))||"Filament inventory")),c.class`fields`.onInput(_).onChange(_).onKeydown(e=>{e.key==="Enter"&&(e.preventDefault(),m())})(z("Filament type",w.onChange(e=>{var u;n.filament_type_id=((u=e==null?void 0:e.target)==null?void 0:u.value)||"",f()})(h.value``.selected(e=>!n.filament_type_id)("Select filament type"),e=>(a||[]).map(u=>h.value(u.filament_type_id).selected(k=>n.filament_type_id===u.filament_type_id)($(u)||u.label||"Unnamed")))),z("ðŸ“ Location",w.onChange(C)(h.value``.selected(e=>!n.location)("Select location"),...I.map(e=>h.value(e).selected(u=>n.location===e)(e).key(e)))),z("Spool Inventory",R.type`number`.value(e=>n.spool_inventory??"").onChange(E(n,"spool_inventory").onChange).onKeyup(E(n,"spool_inventory").onKeyup)())),c.class`edit-card-footer`(r?A.type`button`.class`add-button`.disabled(e=>!i).onClick(m)("ðŸ’¾ Save"):null,d?A.type`button`.class`ghost-button`.onClick(g)("ðŸ§¬ Duplicate"):null,B.class`ghost-button`.href(e=>U())("âœï¸ Edit filament"),A.type`button`.class`ghost-button`.onClick(()=>o(t,(n==null?void 0:n.location)??"")).attr("aria-label","Stop editing inventory")("Done")))}),gt=n=>/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(n),bt=n=>{if(!n)return"";try{return new URL(n).hostname.replace(/^www\./,"")}catch{return n.replace(/^https?:\/\//,"").split("/")[0]}},P=v((n,t,a,o,r)=>{P.updates(l=>{[n,t,a,o,r]=l}),o=F(o);const d=(l,i)=>{const f=Number(n.spool_inventory),_=Math.max(0,(Number.isFinite(f)?f:0)+i);if(n.spool_inventory=_,l!=null&&l.currentTarget){const m=l.currentTarget;m.classList.add("is-clicked"),window.setTimeout(()=>m.classList.remove("is-clicked"),220)}if(r){const m=r();m&&typeof m.then=="function"&&m.catch(()=>{})}};return c.class`summary-row`(c(l=>(t==null?void 0:t.number)||"-"),c.class`summary-swatch`(c.class`summary-chip`.style(l=>`background:${gt(t==null?void 0:t.hex)?t.hex:""};`)(),b.class`summary-swatch-name`(l=>(t==null?void 0:t.color_name)||"Unnamed")),c.class`summary-details`(c.class`summary-title-row`(T(l=>(t==null?void 0:t.label)||"Untitled filament"),A.type`button`.class`summary-edit-button`.onClick(()=>{o(a,(n==null?void 0:n.location)??"")})({"aria-label":"Edit inventory entry"},"âœï¸")),l=>{const i=[],f=$(t);f&&i.push(b.class`summary-meta-item`(f));const _=t!=null&&t.material_type?`Material: ${t.material_type}`:"Material: N/A";if(i.push(b.class`summary-meta-item`(_)),i.push(b.class`summary-meta-item summary-spool-meta`(b.class`summary-spool-label`("Spools:"),b.class`summary-spool-count`(m=>{const g=Number(n.spool_inventory);return Number.isFinite(g)?g:0}),c.class`summary-spool-controls`(A.type`button`.class`spool-adjust-button`.attr("aria-label","Decrease spool count").onClick(m=>d(m,-1))("âˆ’"),A.type`button`.class`spool-adjust-button`.attr("aria-label","Increase spool count").onClick(m=>d(m,1))("+")))),t!=null&&t.url){const m=bt(t.url);i.push(b.class`summary-meta-item`(B.href(t.url).attr("target","_blank").attr("rel","noopener noreferrer")(m||t.url)))}return i.length?c.class`summary-meta`(...i):""}))});let p=null;const Ft=(n,t)=>{if(p&&p.index===n&&(t===void 0||p.location===t)){p=null;return}p={index:n,location:t??""}},H=(n,t="")=>{if(n==null){p=null;return}p={index:n,location:t}},vt=(n,t="")=>{!p||p.index!==n||(p={...p,location:t})},x=v((n,t,a,o,r,d,l,i)=>(x.inputs(f=>{[n,t,a,o,r,d,l,i]=f,r=F(r),l=F(l),i=F(i)}),tt(f=>o?q(n,a,d,r,l,i,vt):P(n,t,a,r,l)))),G=v((n,t)=>{G.updates(s=>{[n,t]=s});let a=[],o=[],r=!1,d=!1,l=!1,i=!1;const f=()=>{var s;a.unshift(kt(I[0]||"",o)),H(0,((s=a[0])==null?void 0:s.location)||"")},_=()=>Lt(a),m=s=>{const y=a[s];if(!y)return;const L={...y,location:y.location||I[0]||""};a.splice(s+1,0,L),H(s+1,L.location||"")};let g="",C="";const U="__unassigned__",e="Unassigned",u=()=>Ut(a,o,{filamentTypeFilter:C,locationFilter:g,unassignedLocation:U}),k=()=>wt(u(),[...I,e]),X=()=>{!V||l||i||(i=!0,v.promise=V().then(s=>{o=Array.isArray(s)?s:[],l=!0}).catch(s=>{console.error("Filament types load failed",s),o=[],l=!0}).finally(()=>{i=!1}))},Y=()=>{if(!D){console.debug("FilamentInventoryApp load skipped: no loader provided");return}r||d||(d=!0,console.debug("FilamentInventoryApp loading inventory..."),v.promise=D().then(s=>{console.debug("FilamentInventoryApp load complete",{count:(s==null?void 0:s.length)||0}),a=O(s||[]),r=!0}).catch(s=>{console.error("FilamentInventoryApp load failed",s),a=O([]),r=!0}).finally(()=>{d=!1}))};return X(),Y(),[nt(_t(n,t),ot("Filament Inventory"),st("Edit filament inventory in place. Changes are saved directly to Firestore.")),at(et.class`panel`(s=>`editIndex:${p==null?void 0:p.index}:`,c.class`meta`(c.class`controls`(c.class`controls-group`(A({id:"addFilamentButton",class:"add-button",type:"button",onClick:f},"âž• Add filament")),c.class`controls-group`(w.value(s=>C??"").onChange(s=>{var y;C=((y=s==null?void 0:s.target)==null?void 0:y.value)||""})(h.value``("Filter by filament type"),...(o||[]).map(s=>h.value(s.filament_type_id)($(s)||s.label||"Untitled"))),w.value(s=>g??"").onChange(s=>{var y;g=((y=s==null?void 0:s.target)==null?void 0:y.value)||""})(h.value``("ðŸ“ Filter by location"),...I.map(s=>h.value(s)(s)),h.value(U)("Unassigned")),c.id`count`(s=>`${u().length} items`)))),c.id`summaryList`.class`summary-list`(s=>k().map(([y,L])=>c.class`location-group`(c.class`location-title-row`(rt.class`location-title`(`ðŸ“ ${y} (${L.length})`),y===e?null:B.class`ghost-button location-fast-edit`.href`./${lt(y)}/fast-edit.html`("âš¡ Fast edit")),zt=>L.map(({item:K,index:M,type:Z})=>x(K,Z,M,(p==null?void 0:p.index)===M,Ft,o,_,m).key(K.filament_type_id||`item-${M}`))).key(y)))))]}),At=n=>I.includes(n)?n:"",It=n=>(Array.isArray(n)?n:[]).map(t=>({...t,location:At(t.location)})),Ct=n=>n.map(t=>{const a={};return t.filament_type_id&&(a.filament_type_id=t.filament_type_id),t.location&&(a.location=t.location),t.spool_inventory!==void 0&&t.spool_inventory!==""&&(a.spool_inventory=Number(t.spool_inventory)||0),a}),kt=(n="",t=[])=>{var a;return{filament_type_id:((a=t==null?void 0:t[0])==null?void 0:a.filament_type_id)||"",spool_inventory:1,location:n}},O=n=>{const t=It(n);return console.debug("Filament inventory loaded",{count:t.length}),t},Lt=n=>v.promise=it(Ct(n)).then(t=>{console.log("save completed",t)}).catch(t=>{console.error("Failed to save filament inventory",t),alert("Save failed. Check the console for details.")}),Ut=(n,t,a)=>n.reduce((o,r,d)=>{const l=!a.filamentTypeFilter||r.filament_type_id===a.filamentTypeFilter,i=ht(r.location,a.locationFilter,a.unassignedLocation);if(l&&i){const f=t==null?void 0:t.find(_=>_.filament_type_id===r.filament_type_id);o.push({item:r,index:d,type:f})}return o},[]),wt=(n,t)=>{const a=new Map;return t.forEach(o=>{a.set(o,[])}),n.forEach(o=>{const r=o.item.location||t[t.length-1];a.has(r)||a.set(r,[]),a.get(r).push(o)}),Array.from(a.entries()).filter(([,o])=>o.length)},S={current:document.getElementById("filamentApp")};let j=!1,J=null;const Q=()=>ct().catch(n=>{console.error("Firebase sign-out failed",n),N.error("Sign out failed. Try again.")}),$t=v(()=>G(Q,J)),Nt=(n="")=>{if(!S.current||j)return;const t=ft(S);t&&(t.replaceChildren(),yt($t,t),j=!0)},W=(n,t,a="")=>{dt({rootRef:S,status:n,userEmail:t,adminEmail:"",onSignIn:()=>mt().catch(o=>{console.error("Firebase sign-in failed",o),N.error("Sign in failed. Try again.")}),onSignOut:Q,setAppMounted:o=>{j=o}})};W("loading","","initial");const Mt=async(n,t="")=>{await pt({user:n,mountSso:W,toast:N,setCurrentUser:o=>{J=o},onAuthorized:()=>{Nt("auth:authorized")},reason:t})};ut({onUser:Mt,toast:N});
