import{t as _,q as P,d as i,h as Y,e as z,g as K,p as q,j as G,s as k,c as h,f as H,u as F,a7 as J,y as g,x as Q,z as W,A as X,w as Z,B as tt,C as et,D as at}from"./auth-handler-C4naTd7l.js";import{B as st}from"./BarcodeScanner.tag-CF72ICAf.js";import{e as nt}from"./barcode-utils-VHKBp8aY.js";import{d as ot,g as rt}from"./filament-match-utils-DrMPFgTu.js";const ct=["code_128","code_39","code_93","ean_13","ean_8","itf","upc_a","upc_e"],it=1200,lt=()=>{let e=null;const l=(d,u)=>{try{e||(e=new AudioContext),e.state==="suspended"&&e.resume().catch(()=>{});const o=e.createOscillator(),f=e.createGain();o.type="sine",o.frequency.value=d,f.gain.value=.12,o.connect(f),f.connect(e.destination),o.start(),o.stop(e.currentTime+u/1e3)}catch(o){console.warn("Audio tone failed",o)}};return{success:()=>l(880,120),fail:()=>l(220,180)}},dt=(e,l)=>{const d=l.toLowerCase(),u=["barcode_search_data","swatch_code","number","label","color_name"];for(const o of u){const f=e.find(y=>{const s=y[o];return Array.isArray(s)?s.some(p=>p==null?void 0:p.toString().toLowerCase().includes(d)):s==null||s===""?!1:s.toString().toLowerCase().includes(d)});if(f)return{type:f,matchKey:rt(f,l)}}return null},I=_((e,l)=>{I.updates(t=>{[e,l]=t}),P(e);const d=lt();let u=[],o=!1,f=!1,y="",s="",p="Choose add or remove to start scanning.",c=[],A={token:"",at:0};const v=()=>{!F||f||o||(f=!0,_.promise=F().then(t=>{u=Array.isArray(t)?t:[],y="",o=!0}).catch(t=>{console.error("Fast edit load failed",t),y="Failed to load filament data.",u=[],o=!0}).finally(()=>{f=!1}))};v();const E=t=>{s=t,p="Scanner active. Point at a barcode."},B=(t,a)=>{if(!a)return;const n=c.find(m=>m.key===a);n?n.count+=1:c.push({key:a,item:t,count:1})},D=t=>{const n=(nt(t||"")||t||"").trim();if(!n){p="No barcode data received.",d.fail();return}const m=Date.now();if(n===A.token&&m-A.at<it)return;A={token:n,at:m};const r=dt(u,n);r!=null&&r.type&&(r!=null&&r.matchKey)?(B(r.type,r.matchKey),p=`Matched ${r.type.label||r.type.color_name||"filament"}.`,d.success()):(p=`No match for ${n}.`,d.fail())},S=(t,a)=>{const n=c.find(r=>r.key===t);if(!n)return;const m=n.count+a;if(m<=0){c=c.filter(r=>r.key!==t);return}n.count=m},x=t=>{c=c.filter(a=>a.key!==t)},V=async()=>{if(!s||!c.length)return;const t=c.reduce((a,n)=>{const m=s==="add"?n.count:-n.count;return a[n.key]=(a[n.key]||0)+m,a},{});try{await J({location:e,adjustments:t}),g.success(s==="add"?"Inventory added.":"Inventory removed."),c=[],o=!1,v()}catch(a){console.error("Fast edit update failed",a),g.error("Update failed. Try again.")}},$=s==="add"?"ADD INVENTORY":"REMOVE FROM INVENTORY",T=()=>c.length>0,w=()=>!!s&&T(),j=()=>s?s==="add"?"SCAN TO ADD INVENTORY":"SCAN TO REMOVE INVENTORY":"SELECT MODE TO CONTINUE";return i.class`fast-edit-page`(Y.class`fast-edit-header`(z({class:"ghost-button fast-edit-back",href:"../index.html"},"← BACK"),i(K("Fast Edit"),q(`Location: ${e||l||"Unknown"}`))),G.class`panel fast-edit-panel`(i.class`fast-edit-mode`(k.class`fast-edit-label`("Mode"),i.class`fast-edit-actions`(h.type`button`.class(t=>`add-button ${s==="add"?"is-active":""}`).onClick(()=>E("add"))("➕ Add"),h.type`button`.class(t=>`add-button ${s==="remove"?"is-active":""}`).onClick(()=>E("remove"))("➖ Remove"))),i.class`fast-edit-status`(t=>p),t=>s?i.class`fast-edit-scanner`(st({onResult:D,formats:ct})):i.class`fast-edit-placeholder`("Select a mode to enable barcode scanning."),t=>y&&i.class`fast-edit-error`(y),t=>T()&&i.class`fast-edit-list`(...c.map(a=>i.class`fast-edit-row`(i.class`fast-edit-row-info`(H(ot(a.item)),k.class`fast-edit-row-meta`(`#${a.item.number||"-"} • ${a.item.material_type||"Material"}`)),i.class`fast-edit-row-count`(h.type`button`.class`spool-adjust-button`.onClick(()=>S(a.key,-1))("−"),k.class`fast-edit-count`(n=>a.count),h.type`button`.class`spool-adjust-button`.onClick(()=>S(a.key,1))("+")),h.type`button`.class`ghost-button fast-edit-remove`.onClick(()=>x(a.key))("Remove")).key(a.key))),h.type`button`.class`add-button fast-edit-submit`.disabled(t=>!w()).onClick(()=>V())(t=>w()?$:j())))}),b={current:document.getElementById("fastEditApp")};var O,M;const ut=((M=(O=b.current)==null?void 0:O.dataset)==null?void 0:M.location)||"";var R,N;const ft=((N=(R=b.current)==null?void 0:R.dataset)==null?void 0:N.locationSlug)||"";let C=!1,L=null;const pt=()=>Z().catch(e=>{console.error("Firebase sign-out failed",e),g.error("Sign out failed. Try again.")}),mt=_(()=>I(ut,ft,L)),yt=()=>{if(!b.current||C)return;const e=et(b);e&&(e.replaceChildren(),at(mt,e),C=!0)},U=(e,l,d="")=>{W({rootRef:b,status:e,userEmail:l,adminEmail:"",onSignIn:()=>X().catch(u=>{console.error("Firebase sign-in failed",u),g.error("Sign in failed. Try again.")}),onSignOut:pt,setAppMounted:u=>{C=u}})};U("loading","","initial");const ht=async e=>{await tt({user:e,mountSso:U,toast:g,setCurrentUser:d=>{L=d},onAuthorized:()=>{yt()}})};Q({onUser:ht,toast:g});
