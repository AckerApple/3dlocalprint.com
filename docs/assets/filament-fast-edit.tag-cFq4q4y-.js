import{t as _,k as P,d,h as j,e as z,f as K,p as Y,g as q,s as A,b as y,c as G,U as M,V as H,v as h,w as J,D as Q,u as W,x as X,y as Z,z as ee,B as te,C as ae}from"./toast-Dm6QH7Hm.js";import{B as oe}from"./BarcodeScanner.tag-Kh2Q6KvU.js";import{e as ne}from"./barcode-utils-Bh5zqa5o.js";import{d as se,g as re}from"./filament-match-utils-C2oTVrRR.js";const ie=["code_128","code_39","code_93","ean_13","ean_8","itf","upc_a","upc_e"],ce=1200,le=()=>{let e=null;const o=(c,u)=>{try{e||(e=new AudioContext),e.state==="suspended"&&e.resume().catch(()=>{});const r=e.createOscillator(),f=e.createGain();r.type="sine",r.frequency.value=c,f.gain.value=.12,r.connect(f),f.connect(e.destination),r.start(),r.stop(e.currentTime+u/1e3)}catch(r){console.warn("Audio tone failed",r)}};return{success:()=>o(880,120),fail:()=>o(220,180)}},de=(e,o)=>{const c=o.toLowerCase(),u=["barcode_search_data","swatch_code","number","label","color_name"];for(const r of u){const f=e.find(g=>{const s=g[r];return Array.isArray(s)?s.some(p=>p==null?void 0:p.toString().toLowerCase().includes(c)):s==null||s===""?!1:s.toString().toLowerCase().includes(c)});if(f)return{type:f,matchKey:re(f,o)}}return null},$=_((e,o)=>{$.updates(t=>{[e,o]=t}),P(e);const c=le();let u=[],r=!1,f=!1,g="",s="",p="Choose add or remove to start scanning.",l=[],v={token:"",at:0};const F=()=>{!M||f||r||(f=!0,_.promise=M().then(t=>{u=Array.isArray(t)?t:[],g="",r=!0}).catch(t=>{console.error("Fast edit load failed",t),g="Failed to load filament data.",u=[],r=!0}).finally(()=>{f=!1}))};F();const w=t=>{s=t,p="Scanner active. Point at a barcode."},x=(t,a)=>{if(!a)return;const n=l.find(m=>m.key===a);n?n.count+=1:l.push({key:a,item:t,count:1})},B=t=>{const n=(ne(t||"")||t||"").trim();if(!n){p="No barcode data received.",c.fail();return}const m=Date.now();if(n===v.token&&m-v.at<ce)return;v={token:n,at:m};const i=de(u,n);i!=null&&i.type&&(i!=null&&i.matchKey)?(x(i.type,i.matchKey),p=`Matched ${i.type.label||i.type.color_name||"filament"}.`,c.success()):(p=`No match for ${n}.`,c.fail())},T=(t,a)=>{const n=l.find(i=>i.key===t);if(!n)return;const m=n.count+a;if(m<=0){l=l.filter(i=>i.key!==t);return}n.count=m},N=t=>{l=l.filter(a=>a.key!==t)},D=async()=>{if(!s||!l.length)return;const t=l.reduce((a,n)=>{const m=s==="add"?n.count:-n.count;return a[n.key]=(a[n.key]||0)+m,a},{});try{await H({location:e,adjustments:t}),h.success(s==="add"?"Inventory added.":"Inventory removed."),l=[],r=!1,F()}catch(a){console.error("Fast edit update failed",a),h.error("Update failed. Try again.")}},V=s==="add"?"ADD INVENTORY":"REMOVE FROM INVENTORY",E=()=>l.length>0;return d.class`fast-edit-page`(j.class`fast-edit-header`(z({class:"ghost-button fast-edit-back",href:"../index.html"},"← BACK"),d(K("Fast Edit"),Y(`Location: ${e||o||"Unknown"}`))),q.class`panel fast-edit-panel`(d.class`fast-edit-mode`(A.class`fast-edit-label`("Mode"),d.class`fast-edit-actions`(y.type`button`.class(t=>`add-button ${s==="add"?"is-active":""}`).onClick(()=>w("add"))("➕ Add"),y.type`button`.class(t=>`add-button ${s==="remove"?"is-active":""}`).onClick(()=>w("remove"))("➖ Remove"))),d.class`fast-edit-status`(t=>p),t=>s?d.class`fast-edit-scanner`(oe({onResult:B,formats:ie})):d.class`fast-edit-placeholder`("Select a mode to enable barcode scanning."),t=>g&&d.class`fast-edit-error`(g),t=>E()&&d.class`fast-edit-list`(...l.map(a=>d.class`fast-edit-row`(d.class`fast-edit-row-info`(G(se(a.item)),A.class`fast-edit-row-meta`(`#${a.item.number||"-"} • ${a.item.material_type||"Material"}`)),d.class`fast-edit-row-count`(y.type`button`.class`spool-adjust-button`.onClick(()=>T(a.key,-1))("−"),A.class`fast-edit-count`(n=>a.count),y.type`button`.class`spool-adjust-button`.onClick(()=>T(a.key,1))("+")),y.type`button`.class`ghost-button fast-edit-remove`.onClick(()=>N(a.key))("Remove")).key(a.key))),t=>E()&&y.type`button`.class`add-button fast-edit-submit`.onClick(()=>D())(V)))}),b={current:document.getElementById("fastEditApp")};var O,R;const ue=((R=(O=b.current)==null?void 0:O.dataset)==null?void 0:R.location)||"";var I,U;const fe=((U=(I=b.current)==null?void 0:I.dataset)==null?void 0:U.locationSlug)||"";let S=!1,C=null;const pe=()=>W().catch(e=>{console.error("Firebase sign-out failed",e),h.error("Sign out failed. Try again.")}),me=_(()=>$(ue,fe,C)),he=()=>{if(!b.current||S)return;const e=te(b);e&&(e.replaceChildren(),ae(me,e),S=!0)},k=(e,o,c="")=>{J({rootRef:b,status:e,userEmail:o,adminEmail:"",onSignIn:()=>Q().catch(u=>{console.error("Firebase sign-in failed",u),h.error("Sign in failed. Try again.")}),onSignOut:pe,setAppMounted:u=>{S=u}})};k("loading","","initial");const L=async e=>{if(!e){C=null,k("login","","auth:logged-out");return}C={email:e.email||"",photoURL:e.photoURL||""};let o=!1;try{o=await ee(e.email||"")}catch(c){console.error("Failed to load admin list",c),h.error("Unable to verify access. Check Firestore rules."),k("denied",e.email||"","auth:permissions");return}if(!o){h.error(`Signed in as ${e.email||"unknown"} but not authorized.`),k("denied",e.email||"","auth:denied");return}he()},ge=async()=>{X().then(({redirectError:e,redirectResult:o,persistence:c})=>{e&&h.error("Sign-in failed after redirect. Try again."),c.error&&h.error("Safari blocked login storage. Check cookie settings."),o!=null&&o.user&&L(o.user)}).catch(e=>{console.error("Failed to prepare auth",e),h.error("Sign-in setup failed. Try again.")}),Z(e=>{L(e)})};ge();
